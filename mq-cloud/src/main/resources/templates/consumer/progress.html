<style type="text/css">
	pre {
		font-size: 11px;
		line-height: 1;
		padding: 0;
		margin: 0;
		border: 0;
		background-color: transparent;
		white-space: pre-wrap;
		overflow-y:hidden;
	}
	#threadMetricsBody td,#threadMessageModal td,#failedMetricsBody td,#failedMessageModal td{
		font-weight: normal;
		font-size:12px;
	}
	.tooltip .tooltip-inner {
		max-width: 500px;
		text-align: left;
	}
</style>
<div class="row">
<div class="col-md-12">
	<div class="card">
		<div class="card-body p-0">
			<div class="list-group list-striped">
				<#if response.empty && resultExt.empty>
					<div class="list-group-item">
						<p class="text-center">暂无数据</p>
					</div>
				<#else>
					<#list response.result as consumerProgressVO>
						<#assign row = (pagination.result.currentPage - 1)*pagination.result.numOfPage + consumerProgressVO_index + 1>
						<div class="list-group-item">
							<ul class="row nav mb-2">
								<li class="col-md-6">
									<p class="m-1">
										<a href="javascript:void(0)" data="${RequestParameters.consumer!}" title="查看消费详情" data-target="#consumeDetailModel${row}" data-toggle="modal" <#if consumerProgressVO.minLastTimestamp gt 0 && consumerProgressVO.minLastTimestamp lt long.MAX_VALUE>onclick="getQueueOwner('${consumerProgressVO.consumer.name}', '${consumerProgressVO.consumer.id}')"</#if>>${consumerProgressVO.consumer.name}</a>
										<#if consumerProgressVO.version??>
											<span class="ml-2" data-toggle="tooltip" onclick="showConsumerStats('${consumerProgressVO.consumer.name}')" title="查看${consumerProgressVO.consumer.name}的客户端统计"><i class="fa-solid fa-chart-line fa-xs text-secondary pointer"></i></span>
										<#else>
											<span class="ml-2" data-toggle="tooltip" title="非MQCloud客户端暂不支持查看客户端统计"><i class="fa-solid fa-chart-line fa-xs disabled"></i></span>
										</#if>
										<span class="ml-1" data-toggle="tooltip" title="点击复制${consumerProgressVO.consumer.name}"><i class="fas fa-copy fa-xs copied text-secondary pointer" data-clipboard-text="${consumerProgressVO.consumer.name}"></i></span>
									</p>
								</li>
								<li class="col-md-3 small">
									<p class="m-1"><span class="text-muted">创建于:</span>&nbsp;&nbsp;${consumerProgressVO.createDateFormat}</p>
								</li>
								<li class="col-md-3 small">
									<p class="m-1">
										<span class="text-muted">消费模式:</span>&nbsp;&nbsp;
										<#if consumerProgressVO.consumer.httpProtocol>
											<font color="blue" data-toggle="tooltip" title="消费协议：HTTP">${consumerProgressVO.messageModel}</font>
											<#elseif consumerProgressVO.consumer.proxyRemoting>
											<font color="blue" data-toggle="tooltip" title="消费协议：Proxy Remoting">${consumerProgressVO.messageModel}</font>
											<#else>
											${consumerProgressVO.messageModel}
										</#if>
									</p>
								</li>
							</ul>
							<ul class="row nav small mb-2">
								<li class="col-md-6">
									<p class="m-1"><span class="text-muted">用途:</span>&nbsp;&nbsp;
									<#if consumerProgressVO.consumer.info?? && consumerProgressVO.consumer.info?length gt 30>
										<span data-toggle="tooltip" title="${consumerProgressVO.consumer.info}">${consumerProgressVO.consumer.info?substring(0,30)}...</span> <#if consumerProgressVO.ownerList?? && (consumerProgressVO.ownerList?seq_contains(userInfo.user) || userInfo.user.type == 1)> <i data-toggle="tooltip" title="修改用途" onclick="showUpdateInfo(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', '${consumerProgressVO.consumer.info!}')" class="fas fa-edit fa-xs text-secondary pointer"></i></#if>
									<#else>
										<#if consumerProgressVO.consumer.info?? && consumerProgressVO.consumer.info !=''>
											${consumerProgressVO.consumer.info} <#if consumerProgressVO.ownerList?? && (consumerProgressVO.ownerList?seq_contains(userInfo.user) || userInfo.user.type == 1)> <span data-toggle="tooltip" title="修改用途"><i onclick="showUpdateInfo(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', '${consumerProgressVO.consumer.info!}')" class="fas fa-edit fa-xs text-secondary pointer"></i></span></#if>
										<#else>
											<#if consumerProgressVO.ownerList?? && (consumerProgressVO.ownerList?seq_contains(userInfo.user) || userInfo.user.type == 1)>
												<span data-toggle="tooltip" title="添加用途"><i onclick="showUpdateInfo(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', '${consumerProgressVO.consumer.info!}')" class="far fa-edit fa-xs text-secondary pointer"></i></span>
				                    		</#if>
										</#if>
									</#if>
									</p>
								</li>
								<li class="col-md-2">
									<p class="m-1" data-toggle="tooltip" title="${consumerProgressVO.consumeTpsRound}"><span class="text-muted">TPS:</span>&nbsp;&nbsp;${consumerProgressVO.consumeTpsFormat}</p>
								</li>
								<li class="col-md-3 offset-md-1">
									<p class="m-1" data-toggle="tooltip" title="所有队列中的最小消费时间"><span class="text-muted">消费到:</span>&nbsp;&nbsp;
									<#if consumerProgressVO.minLastTimestamp == 0>暂无<#else>
										<#if consumerProgressVO.minLastTimestamp == long.MAX_VALUE>
											消费进度不存在
										<#else>
											${consumerProgressVO.minLastTimestamp?number_to_datetime?string("yyyy-MM-dd HH:mm:ss")}
										</#if>
									</#if>
									</p>
								</li>
							</ul>
							<ul class="row nav small">
								<li class="col-md-6">
									<p class="m-1"><span class="text-muted">归属于:</span>&nbsp;&nbsp;
									<#if consumerProgressVO.ownerList??>
										<#if consumerProgressVO.ownerList?seq_contains(userInfo.user) || userInfo.user.type == 1>
											<#if consumerProgressVO.ownerList?size == 1>
												<span>${consumerProgressVO.ownerList[0].name!consumerProgressVO.ownerList[0].getEmailName()}</span>
											<#else>
												<#list consumerProgressVO.ownerList as user>
													<#if user_index != 0>
													,
													</#if>
													<span onclick="prepareDeleteUserConsumer(${user.id},'${user.name!user.getEmailName()}',${consumerProgressVO.consumer.id})" data-toggle="tooltip" title="移除${user.name!user.getEmailName()}?" class="producer_delete pointer">${user.name!user.getEmailName()}</span>
												</#list>
											</#if>
											<span data-toggle="tooltip" title="授权其他用户查看${consumerProgressVO.consumer.name}?"><i onclick="associateUserConsumer(${consumerProgressVO.consumer.id},'${consumerProgressVO.consumer.name}')" class="fas fa-user-plus fa-xs text-secondary pointer"></i></span>
										<#else>
											<#list consumerProgressVO.ownerList as user>
												<#if user_index != 0>
												,
												</#if>
												<span>${user.name!user.getEmailName()}</span>
											</#list>
										</#if>
									<#else>
										暂无
									</#if>
									</p>
								</li>
								<li class="col-md-2">
									<p class="m-1" data-toggle="tooltip" data-placement="bottom" title="<#if consumerProgressVO.needShowLeftTime()>${consumerProgressVO.leftTimeFormat}<#else>${consumerProgressVO.diff}</#if>"><span class="text-muted">堆积量:</span>&nbsp;&nbsp;${consumerProgressVO.diffFormat}</p>
								</li>
								<li class="col-md-3 offset-md-1">
									<p class="m-1"><span class="text-muted">操作:</span>&nbsp;&nbsp;
									<#if (consumerProgressVO.ownerList?? && consumerProgressVO.ownerList?seq_contains(userInfo.user)) || userInfo.user.type == 1>
			                    		<#if consumerProgressVO.offsetMap??>
											<button type="button" class="btn btn-xs btn-outline-secondary" data-toggle="tooltip" title="跳过堆积的消息，直接消费至最新的消息" onclick="skipAccumulationShow('${consumerProgressVO.consumer.name}', ${consumerProgressVO.consumer.id})"><i class="fas fa-fw fa-fast-forward"></i></button>
											<button type="button" class="btn btn-xs btn-outline-secondary" data-toggle="tooltip" title="消费过去一段时间至现在的消息" onclick="resetOffsetShow('${consumerProgressVO.consumer.name}', ${consumerProgressVO.consumer.id})"><i class="fas fa-fw fa-backward"></i></button>
											<#if consumerProgressVO.version??>
												<#if consumerProgressVO.consumerConfig?? && consumerProgressVO.consumerConfig.pause?? && consumerProgressVO.consumerConfig.pause>
													<button type="button" class="btn btn-xs btn-outline-secondary" title="恢复消费" onclick="showPauseConsumeConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', false)" data-toggle="modal"><i class="fas fa-fw fa-play"></i></button>
												<#else>
													<button type="button" class="btn btn-xs btn-outline-secondary" title="暂停消费" onclick="showPauseConsumeConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', true)" data-toggle="modal"><i class="fas fa-fw fa-pause"></i></button>
												</#if>
												<#if consumerProgressVO.consumerConfig?? && consumerProgressVO.consumerConfig.enableRateLimit?? && consumerProgressVO.consumerConfig.enableRateLimit>
													<button type="button" class="btn btn-xs btn-outline-secondary" title="修改消费限速" onclick="showLimitConsumeConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', true, <#if consumerProgressVO.consumerConfig.permitsPerSecond??>${consumerProgressVO.consumerConfig.permitsPerSecond}<#else>${limitConsumeTps}</#if>)" data-toggle="tooltip"><i class="fa-fw fa-solid fa-faucet-drip"></i></button>
												<#else>
					                                <button type="button" class="btn btn-xs btn-outline-secondary" title="限制消费速率" onclick="showLimitConsumeConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', false, <#if consumerProgressVO.consumerConfig?? && consumerProgressVO.consumerConfig.permitsPerSecond??>${consumerProgressVO.consumerConfig.permitsPerSecond}<#else>${limitConsumeTps}</#if>)" data-toggle="tooltip"><i class="fa-fw fa-solid fa-faucet"></i></button>
												</#if>
												<#if topic.traceEnabled()>
													<#if (consumerProgressVO.ownerList?? && consumerProgressVO.ownerList?seq_contains(userInfo.user)) || userInfo.user.type == 1>
														<#if consumerProgressVO.consumer.traceEnabled()>
															<button type="button" class="btn btn-xs btn-outline-secondary" data-toggle="tooltip" title="关闭trace?" onclick="updateConsumerTraceShow(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', 1)"><i class="fas fa-fw fa-eye"></i></button>
														<#else>
															<button type="button" class="btn btn-xs btn-outline-secondary" data-toggle="tooltip" title="开启trace?" onclick="updateConsumerTraceShow(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', 0)"><i class="fas fa-fw fa-eye-slash"></i></button>
														</#if>
													</#if>
												</#if>
												<#if consumerProgressVO.consumer.httpProtocol>
													<button type="button" class="btn btn-xs btn-outline-secondary" title="修改HTTP消费配置" onclick="showHttpConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}')" data-toggle="tooltip"><i class="fa-solid fa-gear"></i></button>
												</#if>
											<#else>
												<button type="button" class="btn btn-xs btn-outline-secondary disabled" title="非MQCloud客户端暂不支持暂停消费" data-toggle="tooltip"><i class="fas fa-fw fa-pause"></i></button>
												<button type="button" class="btn btn-xs btn-outline-secondary disabled" title="非MQCloud客户端暂不支持限制消费速率" data-toggle="tooltip"><i class="fa-fw fa-solid fa-faucet-drip"></i></button>
												<button type="button" class="btn btn-xs btn-outline-secondary disabled" data-toggle="tooltip" title="非MQCloud客户端暂不支持trace"><i class="fas fa-fw fa-eye-slash"></i></button>
											</#if>
			                    		</#if>
			                    		<button type="button" class="btn btn-xs btn-outline-secondary" title="删除${consumerProgressVO.consumer.name}" data-toggle="tooltip" onclick="deleteConsumerShow('${consumerProgressVO.consumer.name}', ${consumerProgressVO.consumer.id})"><i class="fas fa-fw fa-trash-alt"></i></button>
		                    		</#if>
									</p>
								</li>
							</ul>
							<#if consumerProgressVO.offsetMap??>
							<!-- 详情 -->
							<div id="consumeDetailModel${row}" class="modal fade" tabindex="-1" aria-hidden="true" style="overflow-y: auto;">
								<div class="modal-dialog modal-lg">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title"><b class="text-wrap">${consumerProgressVO.consumer.name}</b> 消费详情</h5>
											<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
										</div>
										<div class="modal-body">
										<#if consumerProgressVO.dlqTopic?? && consumerProgressVO.dlqOffsetMap??>
											<div class="card">
												<div class="card-header">
													<span class="text-wrap">死消息Topic：<b class="text-red" data-toggle="tooltip" title="消费失败达到最大重试次数(16)后，将会进入此topic，不再重试">${consumerProgressVO.dlqTopic}</b>
														&nbsp;&nbsp;&nbsp;<button type="button" class="btn btn-xs btn-outline-secondary" title="搜索死消息" onclick="initOffsetMsgModal('dlq', ${row}, '${consumerProgressVO.dlqTopic}', '${consumerProgressVO.consumer.id}', '${consumerProgressVO.consumer.name}','${consumerProgressVO.dlqMaxOffset?c}', false)" data-target="#msgSearchModal" data-toggle="modal"><i class="fas fa-fw fa-search"></i></button>
													</span>
												</div>
												<div class="card-body p-0 table-responsive">
													<table class="table table-striped table-sm table-hover text-nowrap">
														<thead>
															<tr>
																<th>broker</th>
																<th>队列</th>
																<th class="d-none d-sm-table-cell">最小偏移量</th>
																<th class="d-none d-sm-table-cell">最大偏移量</th>
																<th>消息量</th>
																<th>消费时间</th>
															</tr>
														</thead>
														<tbody>
															<#list consumerProgressVO.dlqOffsetMap as k, v>
																<tr>
																	<td>${k.brokerName}</td>
																	<td>${k.queueId}</td>
																	<td class="d-none d-sm-table-cell">
																		${v.minOffset?string(",###")}
																	</td>
																	<td class="d-none d-sm-table-cell">
																		${v.maxOffset?string(",###")}
																	</td>
																	<td>
																		${v.maxOffset - v.minOffset}
																	</td>
																	<#if v.lastUpdateTimestamp <= 0>
																		<td data-toggle='tooltip' title="可能消息被删了">暂无</td>
																	<#else>
																		<td>
																			${v.lastUpdateTimestamp?number_to_datetime?string("yyyy-MM-dd HH:mm:ss")}
																		</td>
																	</#if>
																</tr>
															</#list>
														</tbody>
													</table>
												</div>
											</div>
										</#if>
										<#if consumerProgressVO.retryTopic?? && consumerProgressVO.retryOffsetMap??>
											<div class="card">
												<div class="card-header">
													<span class="text-wrap">重试Topic：<b class="text-red" data-toggle="tooltip" title="消费失败的消息，会重新发回到此topic，以便重试消费">${consumerProgressVO.retryTopic}</b>
													&nbsp;&nbsp;&nbsp;	<button type="button" class="btn btn-xs btn-outline-secondary" id="${consumerProgressVO.consumer.name}" title="搜索重试消息" onclick="initOffsetMsgModal('retry', ${row}, '${consumerProgressVO.retryTopic}', '${consumerProgressVO.consumer.id}', '${consumerProgressVO.consumer.name}','${consumerProgressVO.retryMaxOffset?c}', ${consumerProgressVO.consumer.traceEnabled()?c})" data-target="#msgSearchModal" data-toggle="modal"><i class="fas fa-search fa-fw"></i></button>
														<#if consumerProgressVO.version??>
															<button type="button" class="btn btn-xs btn-outline-secondary" title="跳过重试消息" onclick="showResetRetryMessageOffsetModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}')" data-toggle="tooltip"><i class="fas fa-fw fa-fast-forward"></i></button>
														<#else>
															<button type="button" class="btn btn-xs btn-outline-secondary disabled" title="非MQCloud客户端暂不支持跳过重试消息" data-toggle="tooltip"><i class="fas fa-fw fa-fast-forward"></i></button>
														</#if>
													</span>
												</div>
												<div class="card-body p-0 table-responsive">
													<table class="table table-striped table-sm table-hover text-nowrap">
														<thead>
															<tr>
																<th>客户端</th>
																<th>broker</th>
																<th>队列</th>
																<th class="d-none d-sm-table-cell">broker偏移量</th>
																<th class="d-none d-sm-table-cell">消费者偏移量</th>
																<th>堆积量</th>
																<th>消费时间</th>
															</tr>
														</thead>
														<tbody>
															<#list consumerProgressVO.retryOffsetMap as k, v>
																<tr>
																	<td id="1_${consumerProgressVO.consumer.id}_${k.brokerName}_${k.queueId}"></td>
																	<td>${k.brokerName}</td>
																	<td>${k.queueId}</td>
																	<td class="d-none d-sm-table-cell">
																		${v.brokerOffset?string(",###")}
																	</td>
																	<td class="d-none d-sm-table-cell">
																		${v.consumerOffset?string(",###")}
																	</td>
																	<td>
																		${v.brokerOffset - v.consumerOffset}
																	</td>
																	<#if v.lastTimestamp <= 0>
																		<td data-toggle='tooltip' title="可能消息被删了">暂无</td>
																	<#else>
																		<td>
																			${v.lastTimestamp?number_to_datetime?string("yyyy-MM-dd HH:mm:ss")}
																		</td>
																	</#if>
																</tr>
															</#list>
														</tbody>
													</table>
												</div>
											</div>
										</#if>
											<div class="card">
												<div class="card-header">
													<span class="text-wrap">Topic：<b>${consumerProgressVO.topic}</b></span>
												</div>
												<div class="card-body p-0 table-responsive">
													<table class="table table-striped table-sm table-hover text-nowrap">
														<thead>
															<tr>
																<th>客户端</th>
																<th>broker</th>
																<th>队列</th>
																<th class="d-none d-sm-table-cell">broker偏移量</th>
																<th class="d-none d-sm-table-cell">消费者偏移量</th>
																<th>堆积量</th>
																<th>消费时间</th>
																<th>操作</th>
															</tr>
														</thead>
														<tbody>
															<#list consumerProgressVO.offsetMap as k, v>
																<tr>
																	<td id="0_${consumerProgressVO.consumer.id}_${k.brokerName}_${k.queueId}" onclick="consumerRunningInfoModelShow('${consumerProgressVO.consumer.name}', this)"></td>
																	<td>${k.brokerName}</td>
																	<td>${k.queueId}</td>
																	<td class="d-none d-sm-table-cell">
																		${v.brokerOffset?string(",###")}
																	</td>
																	<td class="d-none d-sm-table-cell">
																		${v.consumerOffset?string(",###")}
																	</td>
																	<td>
																		${v.brokerOffset - v.consumerOffset}
																	</td>
																	<#if v.lastTimestamp <= 0>
																		<td data-toggle='tooltip' title="可能消息被删了">暂无</td>
																	<#else>
																		<td>
																			${v.lastTimestamp?number_to_datetime?string("yyyy-MM-dd HH:mm:ss")}
																		</td>
																	</#if>
																	<td>
																		<#if consumerProgressVO.version??>
																			<button id="0_${consumerProgressVO.consumer.id}_${k.brokerName}_${k.queueId}_thread" type="button" class="btn btn-xs btn-outline-secondary" data-toggle="tooltip" title="消费线程诊断" onclick="showThreadMetricsForClustering('0_${consumerProgressVO.consumer.id}_${k.brokerName}_${k.queueId}', '${consumerProgressVO.consumer.name}')"><i class="fas fa-stethoscope"></i></button>
																			<button id="0_${consumerProgressVO.consumer.id}_${k.brokerName}_${k.queueId}_excption" type="button" class="btn btn-xs btn-outline-secondary" data-toggle="tooltip" title="消费异常诊断" onclick="showFailedMetricsForClustering('0_${consumerProgressVO.consumer.id}_${k.brokerName}_${k.queueId}', '${consumerProgressVO.consumer.name}')"><i class="fas fa-exclamation-circle"></i></button>
																			<button id="0_${consumerProgressVO.consumer.id}_${k.brokerName}_${k.queueId}_pause" style="display: none" type="button" data-clientId="" class="btn btn-xs btn-outline-secondary" data-toggle="tooltip" title="暂停消费实例" onclick="showPauseConsumeConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', true, this)"><i class="fas fa-pause-circle"></i></button>
																			<button id="0_${consumerProgressVO.consumer.id}_${k.brokerName}_${k.queueId}_resume" style="display: none" type="button" data-clientId="" class="btn btn-xs btn-outline-secondary" data-toggle="tooltip" title="恢复消费实例" onclick="showPauseConsumeConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', false, this)"><i class="fas fa-play-circle"></i></button>
																		<#else>
																			<button type="button" class="btn btn-xs btn-outline-secondary disabled" data-toggle="tooltip" title="非MQCloud客户端暂不支持消费线程诊断"><i class="fas fa-stethoscope"></i></button>
																			<button type="button" class="btn btn-xs btn-outline-secondary disabled" data-toggle="tooltip" title="非MQCloud客户端暂不支持消费异常诊断"><i class="fas fa-exclamation-circle"></i></button>
																			<button type="button" class="btn btn-xs btn-outline-secondary disabled" data-toggle="tooltip" title="非MQCloud客户端暂不支持暂停消费"><i class="fas fa-pause-circle"></i></button>
																		</#if>
																	</td>
																</tr>
															</#list>
														</tbody>
													</table>
												</div>
											</div> <!-- 消费详情结束 -->
										</div> <!-- modal-body结束 -->
									</div> <!-- modal-content结束 -->
								</div> <!-- modal-dialog结束 -->
							</div> <!-- 详情结束 -->
							</#if>
						</div>
					</#list>
					<!-- 广播模式 -->
					<#list resultExt.result as consumerProgressVO>
						<#assign row = (pagination.result.currentPage - 1)*pagination.result.numOfPage + consumerProgressVO_index + 1 + response.result?size>
						<div class="list-group-item">
							<ul class="row nav mb-2">
								<li class="col-md-6">
									<p class="m-1">
										<a href="javascript:void(0)" data="${RequestParameters.consumer!}" title="查看消费详情" data-target="#consumeDetailModel${row}b" data-toggle="modal">${consumerProgressVO.consumer.name}</a>
										<#if consumerProgressVO.version??>
											<span class="ml-2" data-toggle="tooltip" onclick="showConsumerStats('${consumerProgressVO.consumer.name}')" title="查看${consumerProgressVO.consumer.name}的客户端统计"><i class="fa-solid fa-chart-line fa-xs text-secondary pointer"></i></span>
										<#else>
											<span class="ml-2" data-toggle="tooltip" title="非MQCloud客户端暂不支持查看客户端统计"><i class="fa-solid fa-chart-line fa-xs disabled"></i></span>
										</#if>
										<span class="ml-1" data-toggle="tooltip" title="点击复制${consumerProgressVO.consumer.name}"><i class="fas fa-copy fa-xs copied text-secondary pointer" data-clipboard-text="${consumerProgressVO.consumer.name}"></i></span>
									</p>
								</li>
								<li class="col-md-3 small">
									<p class="m-1"><span class="text-muted">创建于:</span>&nbsp;&nbsp;${consumerProgressVO.createDateFormat}</p>
								</li>
								<li class="col-md-3 small">
									<p class="m-1">
										<span class="text-muted">消费模式:</span>&nbsp;&nbsp;
										<#if consumerProgressVO.consumer.httpProtocol>
											<font color="blue" data-toggle="tooltip" title="消费协议：HTTP">${consumerProgressVO.messageModel}</font>
											<#elseif consumerProgressVO.consumer.proxyRemoting>
											<font color="blue" data-toggle="tooltip" title="消费协议：Proxy Remoting">${consumerProgressVO.messageModel}</font>
											<#else>
											${consumerProgressVO.messageModel}
										</#if>
									</p>
								</li>
							</ul>
							<ul class="row nav small mb-2">
								<li class="col-md-6">
									<p class="m-1"><span class="text-muted">用途:</span>&nbsp;&nbsp;
									<#if consumerProgressVO.consumer.info?? && consumerProgressVO.consumer.info?length gt 30>
										<span data-toggle="tooltip" title="${consumerProgressVO.consumer.info}">${consumerProgressVO.consumer.info?substring(0,30)}...</span> <#if consumerProgressVO.ownerList?? && (consumerProgressVO.ownerList?seq_contains(userInfo.user) || userInfo.user.type == 1)><span data-toggle="tooltip" title="修改用途"><i onclick="showUpdateInfo(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', '${consumerProgressVO.consumer.info!}')" class="fas fa-edit fa-xs text-secondary pointer"></i></span></#if>
									<#else>
										<#if consumerProgressVO.consumer.info?? && consumerProgressVO.consumer.info !=''>
											${consumerProgressVO.consumer.info} <#if consumerProgressVO.ownerList?? && (consumerProgressVO.ownerList?seq_contains(userInfo.user) || userInfo.user.type == 1)><span data-toggle="tooltip" title="修改用途"><i class="fas fa-edit fa-xs text-secondary pointer" onclick="showUpdateInfo(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', '${consumerProgressVO.consumer.info!}')"></i></span></#if>
										<#else>
											<#if consumerProgressVO.ownerList?? && (consumerProgressVO.ownerList?seq_contains(userInfo.user) || userInfo.user.type == 1)>
												<span data-toggle="tooltip" title="添加用途"><i onclick="showUpdateInfo(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', '${consumerProgressVO.consumer.info!}')" class="far fa-edit fa-xs pointer"></i></span>
				                    		</#if>
										</#if>
									</#if>
									</p>
								</li>
								<li class="col-md-2">
									<p class="m-1" data-toggle="tooltip" title="${consumerProgressVO.consumeTpsRound}"><span class="text-muted">TPS:</span>&nbsp;&nbsp;${consumerProgressVO.consumeTpsFormat}</p>
								</li>
								<li class="col-md-3 offset-md-1">
									<p class="m-1" data-toggle="tooltip" title="所有队列中的最小消费时间"><span class="text-muted">消费到:</span>&nbsp;&nbsp;
									<#if consumerProgressVO.minLastTimestamp == 0>暂无<#else>
										<#if consumerProgressVO.minLastTimestamp == long.MAX_VALUE>
											消费进度不存在
										<#else>
											${consumerProgressVO.minLastTimestamp?number_to_datetime?string("yyyy-MM-dd HH:mm:ss")}
										</#if>
									</#if>
									</p>
								</li>
							</ul>
							<ul class="row nav small">
								<li class="col-md-6">
									<p class="m-1"><span class="text-muted">归属于:</span>&nbsp;&nbsp;
									<#if consumerProgressVO.ownerList??>
										<#if consumerProgressVO.ownerList?seq_contains(userInfo.user) || userInfo.user.type == 1>
											<#if consumerProgressVO.ownerList?size == 1>
												<span>${consumerProgressVO.ownerList[0].name!consumerProgressVO.ownerList[0].getEmailName()}</span>
											<#else>
												<#list consumerProgressVO.ownerList as user>
													<#if user_index != 0>
													,
													</#if>
													<span onclick="prepareDeleteUserConsumer(${user.id},'${user.name!user.getEmailName()}',${consumerProgressVO.consumer.id})" data-toggle="tooltip" title="移除${user.name!user.getEmailName()}?" class="producer_delete pointer">${user.name!user.getEmailName()}</span>
												</#list>
											</#if>
											<span data-toggle="tooltip" title="授权其他用户查看${consumerProgressVO.consumer.name}?"><i onclick="associateUserConsumer(${consumerProgressVO.consumer.id},'${consumerProgressVO.consumer.name}')" class="fas fa-user-plus fa-xs text-secondary pointer"></i></span>
										<#else>
											<#list consumerProgressVO.ownerList as user>
												<#if user_index != 0>
												,
												</#if>
												<span>${user.name!user.getEmailName()}</span>
											</#list>
										</#if>
									<#else>
										暂无
									</#if>
									</p>
								</li>
								<li class="col-md-2">
									<p class="m-1" data-toggle="tooltip" title="${consumerProgressVO.diff}"><span class="text-muted">堆积量:</span>&nbsp;&nbsp;${consumerProgressVO.diffFormat}</p>
								</li>
								<li class="col-md-3 offset-md-1">
									<p class="m-1"><span class="text-muted">操作:</span>&nbsp;&nbsp;
									<#if (consumerProgressVO.ownerList?? && consumerProgressVO.ownerList?seq_contains(userInfo.user)) || userInfo.user.type == 1>
			                    		<#if consumerProgressVO.offsetMap??>
											<button type="button" class="btn btn-xs btn-outline-secondary" data-toggle="tooltip" title="跳过堆积的消息，直接消费至最新的消息" onclick="skipAccumulationShow('${consumerProgressVO.consumer.name}', ${consumerProgressVO.consumer.id})"><i class="fas fa-fw fa-fast-forward"></i></button>
				                    		<button type="button" class="btn btn-xs btn-outline-secondary" data-toggle="tooltip" title="消费过去一段时间至现在的消息" onclick="resetOffsetShow('${consumerProgressVO.consumer.name}', ${consumerProgressVO.consumer.id})"><i class="fas fa-fw fa-backward"></i></button>
											<#if consumerProgressVO.version??>
												<#if consumerProgressVO.consumerConfig?? && consumerProgressVO.consumerConfig.pause?? && consumerProgressVO.consumerConfig.pause>
													<button type="button" class="btn btn-xs btn-outline-secondary" title="恢复消费" onclick="showPauseConsumeConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', false)" data-toggle="tooltip"><i class="fas fa-fw fa-play"></i></button>
												<#else>
													<button type="button" class="btn btn-xs btn-outline-secondary" title="暂停消费" onclick="showPauseConsumeConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', true)" data-toggle="tooltip"><i class="fas fa-fw fa-pause"></i></button>
												</#if>
												<#if consumerProgressVO.consumerConfig?? && consumerProgressVO.consumerConfig.enableRateLimit?? && consumerProgressVO.consumerConfig.enableRateLimit>
													<button type="button" class="btn btn-xs btn-outline-secondary" title="修改消费限速" onclick="showLimitConsumeConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', true, <#if consumerProgressVO.consumerConfig.permitsPerSecond??>${consumerProgressVO.consumerConfig.permitsPerSecond}<#else>${limitConsumeTps}</#if>)" data-toggle="tooltip"><i class="fa-fw fa-solid fa-faucet-drip"></i></button>
												<#else>
													<button type="button" class="btn btn-xs btn-outline-secondary" title="限制消费速率" onclick="showLimitConsumeConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', false, <#if consumerProgressVO.consumerConfig?? && consumerProgressVO.consumerConfig.permitsPerSecond??>${consumerProgressVO.consumerConfig.permitsPerSecond}<#else>${limitConsumeTps}</#if>)" data-toggle="tooltip"><i class="fa-fw fa-solid fa-faucet"></i></button>
												</#if>
												<#if consumerProgressVO.consumer.httpProtocol>
													<button type="button" class="btn btn-xs btn-outline-secondary" title="修改HTTP消费配置" onclick="showHttpConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}')" data-toggle="tooltip"><i class="fa-solid fa-gear"></i></button>
												</#if>
											<#else>
												<button type="button" class="btn btn-xs btn-outline-secondary disabled" title="非MQCloud客户端暂不支持暂停消费" data-toggle="tooltip"><i class="fas fa-fw fa-pause"></i></button>
												<button type="button" class="btn btn-xs btn-outline-secondary disabled" title="非MQCloud客户端暂不支持限制消费速率" data-toggle="tooltip"><i class="fa-fw fa-solid fa-faucet-drip"></i></button>
											</#if>
			                    		</#if>
			                    		<button type="button" class="btn btn-xs btn-outline-secondary" title="删除${consumerProgressVO.consumer.name}" data-toggle="tooltip"  onclick="deleteConsumerShow('${consumerProgressVO.consumer.name}', ${consumerProgressVO.consumer.id})"><i class="fas fa-fw fa-trash-alt"></i></button>
		                    		</#if>
									</p>
								</li>
							</ul>
							<#if consumerProgressVO.offsetMap??>
							<!-- 详情 -->
							<div id="consumeDetailModel${row}b" class="modal fade" tabindex="-1" aria-hidden="true" style="overflow-y: auto;">
								<div class="modal-dialog modal-xl">
									<div class="modal-content">
										<div class="modal-header">
											<h5 class="modal-title"><b class="text-wrap">${consumerProgressVO.consumer.name}</b> 消费详情</h5>
											<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
										</div>
										<div class="modal-body">
										<div class="card">
										<div class="card-body p-0 table-responsive">
										<table class="table table-striped table-sm table-hover text-nowrap">
											<#if consumerProgressVO.consumer.httpProtocol>
											<colgroup class="colgroup">
												<col width="150px">
												<col>
												<col>
												<col>
												<col>
												<col>
												<col>
												<col>
											</colgroup>
											</#if>
											<thead>
												<tr>
													<#if consumerProgressVO.consumer.httpProtocol && consumerProgressVO.consumer.clustering>
													<th>代理服务器</th>
													<#else>
													<th>clientId</th>
													</#if>
													<th>broker</th>
													<th>队列</th>
													<th class="d-none d-sm-table-cell">broker偏移量</th>
													<th class="d-none d-sm-table-cell">消费者偏移量</th>
													<th>堆积量</th>
													<#if consumerProgressVO.consumer.httpProtocol>
													<th>消费时间</th>
													<th data-toggle="tooltip" title="单位: 秒.毫秒">锁定时间</th>
													<#if consumerProgressVO.consumer.clustering>
													<th>客户端ip</th>
													</#if>
													</#if>
												</tr>
											</thead>
											<tbody>
												<#list consumerProgressVO.consumeStatsList as consumeStats>
													<tr>
														<td rowspan=${consumeStats.offsetTable?size+1} <#if !consumerProgressVO.consumer.httpProtocol>align="center"</#if>>
															<#if !consumerProgressVO.consumer.httpProtocol>
																${consumeStats.clientId}
																<br>
																<#if consumerProgressVO.version??>
																	<button type="button" class="btn btn-xs btn-outline-secondary" onclick="showThreadMetrics('${consumeStats.clientId}','${consumerProgressVO.consumer.name}')"><span data-toggle="tooltip" title="消费线程诊断" class="fas fa-stethoscope"></span></button>
																	<button type="button" class="btn btn-xs btn-outline-secondary" onclick="showFailedMetrics('${consumeStats.clientId}','${consumerProgressVO.consumer.name}')"><span  data-toggle="tooltip" title="消费异常诊断" class="fas fa-exclamation-circle"></span></button>
																	<#if consumeStats.paused>
																		<button <#if consumeStats.disablePause>disabled="disabled"</#if> type="button" data-clientId="${consumeStats.clientId}" class="btn btn-xs btn-outline-secondary" data-toggle="tooltip" title="恢复消费实例" onclick="showPauseConsumeConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', false, this)"><i class="fas fa-play-circle"></i></button>
																	<#else>
																		<button type="button" data-clientId="${consumeStats.clientId}" class="btn btn-xs btn-outline-secondary" data-toggle="tooltip" title="暂停消费实例" onclick="showPauseConsumeConfigModel(${consumerProgressVO.consumer.id}, '${consumerProgressVO.consumer.name}', true, this)"><i class="fas fa-pause-circle"></i></button>
																	</#if>
																<#else>
																	<button type="button" class="btn btn-xs btn-outline-secondary disabled" data-toggle="tooltip" title="非MQCloud客户端暂不支持消费线程诊断"><i class="fas fa-stethoscope"></i></button>
																	<button type="button" class="btn btn-xs btn-outline-secondary disabled" data-toggle="tooltip" title="非MQCloud客户端暂不支持消费异常诊断"><i class="fas fa-exclamation-circle"></i></button>
																	<button type="button" class="btn btn-xs btn-outline-secondary disabled" data-toggle="tooltip" title="非MQCloud客户端暂不支持暂停消费"><i class="fas fa-pause-circle"></i></button>
																</#if>
															<#else>
																${consumeStats.clientIdHtml}
															</#if>
														</td>
													</tr>
													<#list consumeStats.offsetTable as mq,offset>
													<tr>
														<td style="padding-left:0.3rem;">${mq.brokerName}</td>
														<td>${mq.queueId}</td>
														<td class="d-none d-sm-table-cell">
															${offset.brokerOffset?string(",###")}
														</td>
														<td class="d-none d-sm-table-cell">
															${offset.consumerOffset?string(",###")}
														</td>
														<td>
															<#if offset.brokerOffset gt offset.consumerOffset>
																${offset.brokerOffset - offset.consumerOffset}
															<#else>
																0
															</#if>
														</td>
														<#if consumerProgressVO.consumer.httpProtocol>
														<td>
															<#if offset.lastTimestamp <= 0>
																暂无
															<#else>
																${offset.lastTimestamp?number_to_datetime?string("yyyy-MM-dd HH:mm:ss")}
															</#if>
														</td>
														<td>
															${offset.lockTime}
														</td>
														<#if consumerProgressVO.consumer.clustering>
															<td>
																${offset.clientIp!}
															</td>
														</#if>
														</#if>
													</tr>
													</#list>
												</#list>
											</tbody>
										</table>
										</div>
										</div>
										</div>
									</div>
								</div>
							</div> <!-- 详情结束 -->
							</#if>
						</div>
					</#list>
				</#if>
			</div>
		</div>
		<#if pagination.OK && pagination.result.totalPages gt 1>
			<div class="card-footer clearfix">
				<ul id="pagination" data-url="${request.contextPath}/user/topic/${RequestParameters.tid}/detail?tab=consume" style="float:right"></ul>
			</div>
		</#if>
    </div>
</div>
<!-- 提示弹窗 -->
<div class="modal fade" id="deleteUserConsumerModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
		  <h5 class="modal-title">确定要移除用户吗？</h5>
		  <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
      </div>
		<div class="modal-body">
			<div class="input-group mb-3">
				<label class="col-form-label col-md-3"> 用户: </label>
				<div class="col-md-9">
					<input type="text" id="user_name" class="form-control" readonly="readonly"/>
					<input type="hidden" id="currentUid"/>
					<input type="hidden" id="currentCid"/>
				</div>
			</div>
		</div>
		<div  class="modal-footer justify-content-between">
			<button type="button" data-dismiss="modal" class="btn btn-default" >取消</button>
			<button type="button" id="deleteUserConsumerBtn" onclick="deleteUserConsumer()" class="btn btn-primary">确定</button>
		</div>
    </div>
  </div>
</div>
<div id="addUserConsumerModal" class="modal fade" tabindex="-1" data-width="400">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">授权其他用户</h5>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<div class="input-group mb-3">
					<label class="col-form-label col-md-3"> Topic: </label>
					<div class="col-md-9">
						<input type="text" id="topicName" readonly="readonly" class="form-control"/>
					</div>
				</div>
				<div id="consumerGroup" class="input-group mb-3">
					<label class="col-form-label col-md-3"> 消费者: </label>
					<div class="col-md-9">
						<input type="text" id="consumerGroupName" readonly="readonly" class="form-control" />
						<input type="hidden" id="consumerGroupID"/>
					</div>
				</div>
				<div class="input-group mb-3">
					<label class="col-form-label col-md-3"> 选择用户: </label>
					<div class="col-md-9">
						<select id="user_search_select" class="selectpicker  form-control" title="请选择" data-live-search-placeholder="搜索" data-live-search="true"></select>
					</div>
				</div>
			</div>
			<div  class="modal-footer justify-content-between">
				<button type="button" data-dismiss="modal" class="btn btn-default" >取消</button>
				<button type="button" class="btn btn-primary" id="associateUserConsumerBtn" onclick="addUserCounsumerRelationship()">确定</button>
			</div>
		</div>
	</div>
</div>
</div>
<!-- 准备搜索部分 -->
<div class="row">
	<div class="col-md-12">
		<div style="float:left;margin:10px 5px;"><h5><b>${topic.name}</b> 消费流量图</h5></div>
		<div id="consume_search" style="float:right;margin:10px 0px;"></div>
	</div>
</div>
<!-- 准备曲线图 -->
<div id="consume_lineChart"><center>暂无数据</center></div>

<!-- 偏移量消息搜索 -->
<div id="msgSearchModal" class="modal fade" style="overflow-y: auto;">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title"><span id="msgTypeSpan"></span>消息查询</h5>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<div class="card">
					<div class="card-body text-sm">
						<form id="msgSearchForm">
							<div class="row">
								<div class="col-md-2">
									<div class="form-group">
										<label>查询方式: </label>
										<select id="searchCondition" class="form-control selectpicker border">
											<option value="key">key</option>
											<option value="offset">偏移量</option>
											<option value="time">时间段</option>
										</select>
									</div>
								</div>
								<div class="col-md-3">
									<!-- 时间段查询 -->
									<div class="form-group time" style="display:none;">
										<label> 开始时间: </label>
										<div class="input-group mb-3" id="timeStartTimePicker" data-target-input="nearest">
											<input type="text" id="timeStartTimePickerInput" class="form-control datetimepicker-input" data-target="#timeStartTimePicker"/>
											<div class="input-group-append" data-target="#timeStartTimePicker" data-toggle="datetimepicker">
												<div class="input-group-text"><i class="far fa-clock"></i></div>
											</div>
										</div>
									</div>

									<!-- key查询 -->
									<div class="form-group key">
										<label> 开始时间: </label>
										<div class="input-group mb-3" id="keyStartTimePicker" data-target-input="nearest">
											<input type="text" id="keyStartTimePickerInput" class="form-control datetimepicker-input" data-target="#keyStartTimePicker"/>
											<div class="input-group-append" data-target="#keyStartTimePicker" data-toggle="datetimepicker">
												<div class="input-group-text"><i class="far fa-clock"></i></div>
											</div>
										</div>
									</div>

									<!-- 偏移量查询 -->
									<div class="form-group offset" style="display:none;">
										<label> 起始偏移量: </label>
										<input id="offsetStart" name="offsetStart" type="text" class="form-control" placeholder="broker最小偏移量">
									</div>
								</div>
								<div class="col-md-3">
									<!-- 时间段查询 -->
									<div class="form-group time" style="display:none;">
										<label>结束时间: </label>
										<div class="input-group" id="timeEndTimePicker" data-target-input="nearest">
											<input type="text" id="timeEndTimePickerInput" class="form-control datetimepicker-input" data-target="#timeEndTimePicker"/>
											<div class="input-group-append" data-target="#timeEndTimePicker" data-toggle="datetimepicker">
												<div class="input-group-text"><i class="far fa-clock"></i></div>
											</div>
										</div>
									</div>

									<!-- key查询 -->
									<div class="form-group key">
										<label>结束时间: </label>
										<div class="input-group mb-3" id="keyEndTimePicker" data-target-input="nearest">
											<input type="text" id="keyEndTimePickerInput" class="form-control datetimepicker-input" data-target="#keyEndTimePicker"/>
											<div class="input-group-append" data-target="#keyEndTimePicker" data-toggle="datetimepicker">
												<div class="input-group-text"><i class="far fa-clock"></i></div>
											</div>
										</div>
									</div>

									<!-- 偏移量查询 -->
									<div class="form-group offset" style="display:none;">
										<label> 结束偏移量: </label>
										<input id="offsetEnd" name="offsetEnd" type="text" class="form-control" placeholder="broker最大偏移量">
									</div>
								</div>
								<div class="col-md-4">
									<!-- 时间段查询 -->
									<div class="form-group time" style="display:none;">
										<label> 查询: </label>
										<div class="input-group">
											<input type="text" class="form-control" id="key" name="key" placeholder="关键字，支持模糊匹配">
											<div class="input-group-append">
												<button type="button" class="btn btn-default" onclick="searchMessage(false)">
													<i class="fa fa-search"></i>
												</button>
											</div>
											<!-- 时间段消费 -->
											<button type="button" id="exportTimespanMessageBtn" data-toggle='tooltip' title="导出该时间段内的消息" onclick="exportTimespanMessageTip()" class="ml-1 btn btn-sm btn-default time" style="display:none;"><i class="fa-solid fa-file-export"></i></button>
											<button type="button" id="consumeTimespanMessageBtn" data-toggle='tooltip' title="重新消费该时间段内的消息" onclick="consumeTimespanMessageTip()" class="ml-1 btn btn-sm btn-default time" style="display:none;"><i class="fas fa-reply"></i></button>
											<button type="button" data-toggle='tooltip' title="重发消息" onclick="resendMessageTip()" class="ml-1 btn btn-default resendMessageBtn"><i class="far fa-paper-plane"></i></button>
										</div>
									</div>

									<!-- key查询 -->
									<div class="form-group key">
										<label> 查询: </label>
										<div class="input-group">
											<input type="text" class="form-control" id="msgKey" name="msgKey" placeholder="消息key">
											<div class="input-group-append">
												<button type="button" class="btn btn-default" onclick="searchKeyMessage()">
													<i class="fa fa-search"></i>
												</button>
											</div>
											<button type="button" data-toggle='tooltip' title="重发消息" onclick="resendMessageTip()" class="ml-1 btn btn-default resendMessageBtn"><i class="far fa-paper-plane"></i></button>
										</div>
									</div>

									<!-- 偏移量查询 -->
									<div class="form-group offset" style="display:none;">
										<div class="row">
											<div class="col-md-6 mb-2">
												<label> 选择broker: </label>
												<div class="input-group">
													<select id="brokerNameSearchSelect" class="selectpicker border form-control" name="toBrokerName" onchange="brokerNameSelectChange(this)"></select>
												</div>
											</div>
											<div class="col-md-6 mb-2">
												<label> 选择队列: </label>
												<div class="input-group">
													<select id="queueSearchSelect" class="selectpicker border form-control" name="toQueue" onchange="queueSelectChange(this)">
														<option value="-1">全部队列</option>
													</select>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div> <!-- row -->
							<div class="row offset" style="display:none;">
								<div class="col-md-12">
									<!-- 偏移量查询 -->
									<div class="form-group offset" style="display:none;">
										<div class="input-group">
											<input type="text" class="form-control" id="toKey" name="toKey" placeholder="关键字">
											<div class="input-group-append">
												<button type="button" class="btn btn-default" onclick="searchOffsetMessage(false)">
													<i class="fa fa-search"></i>
												</button>
											</div>
											<!-- 消息重发 -->
											<button type="button" data-toggle='tooltip' title="重发消息" onclick="resendMessageTip()" class="ml-1 btn btn-default resendMessageBtn"><i class="far fa-paper-plane"></i></button>
										</div>
									</div>
								</div>
							</div>
							<input type="hidden" id="toCid" name="toCid" value="${topic.clusterId}">
							<input type="hidden" id="toTopic" name="toTopic" value="">
							<input type="hidden" id="messageConsumerId">
							<input type="hidden" id="messageConsumer">
							<input type="hidden" id="toMessageParam" name="toMessageParam">
							<input type="hidden" id="toAppend" name="toAppend" value="false">
							<input type="hidden" id="traceEnabled" name="traceEnabled" value="false">
							<input type="hidden" id="topicId" name="topicId" value="${topic.id}">
							<input type="hidden" name="startTime" id="timeStartTime" value="${.now?long-300000}">
							<input type="hidden" name="endTime" id="timeEndTime" value="${.now?long}">
							<input type="hidden" id="keyStartTime" name="keyStartTime" value="${.now?long-86400000}">
							<input type="hidden" name="keyEndTime" id="keyEndTime" value="${.now?long}">
						</form>
					</div>
				</div>
				<div class="card">
					<div class="card-body table-responsive p-0">
						<table id="dataTable" class="table table-striped table-sm table-hover" style="word-break:break-all; word-wrap:break-all;table-layout:fixed;">
							<colgroup class="colgroup">
								<col width="35px">
								<col width="110px">
								<col width="190px">
								<col width="100px">
								<col width="200px">
								<col width="20px">
							</colgroup>
							<thead>
								<tr class="text-sm">
									<th class="text-center" style="padding-left:0px;">序号</th>
									<th>客户端</th>
									<th>重试时间</th>
									<th>消费次数</th>
									<th>key</th>
									<th><input id="checkInput" title="全选或取消全选" data-toggle="tooltip" onclick="toggleMsgCheck(this)" type="checkbox"></th>
								</tr>
							</thead>
							<tbody>
								<tr><td colspan=6 class="text-center">暂无数据</td></tr>
							</tbody>
						</table>
					</div>
					<div class="card-footer clearfix" id="pager" style="display:none;">
						<div class="d-flex justify-content-between">
							<button id="previous" class="btn btn-outline-primary btn-xs" title="上一页" data-toggle="tooltip" onclick="previous()"><i class="fas fa-backward"></i></button>
							<div class="text-primary text-sm">第<b id="pageNum"></b>页，命中数：<b id="sizeNum"></b>，检索数：<b id="searchNum"></b><span class="d-none d-lg-inline">，预估剩余数：<b id="leftNum"></b></span></div>
							<button id="next" class="btn btn-outline-primary btn-xs" title="下一页" data-toggle="tooltip" onclick="next()"><i class="fas fa-forward"></i></button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<#--修改consumer描述-->
<div id="updateConsumerInfoModal" class="modal fade" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title"><b id="consumerTitle"></b>用途更新</h5>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<div class="input-group mb-3">
					<label class="col-form-label col-md-2"> 用途: </label>
					<div class="col-md-9">
						<textarea id="consumerInfo" rows="5" class="form-control"></textarea>
					</div>
					<input type="hidden" id="currentConsumerID">
				</div>
			</div>
			<div  class="modal-footer justify-content-between">
				<button type="button" data-dismiss="modal" class="btn btn-default" >取消</button>
				<button type="button" class="btn btn-primary" id="updateConsumerInfoBtn" onclick="updateConsumerInfo()">确定</button>
			</div>
		</div>
	</div>
</div> 

<!-- 重试消息跳过-->
<div id="resetRetryMessageOffsetModel" class="modal fade" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">跳过重试消息</h5>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
				<div class="modal-body">
					<div class="input-group mb-3">
						<label class="col-form-label col-md-3"> 消费者: </label>
						<div class="col-md-9">
							<input type="text" id="resetRetryMessageOffsetConsumer" name="consumer" readonly="readonly" class="form-control" />
							<input type="hidden" id="resetRetryMessageOffsetConsumerId">
						</div>
					</div>
					<div class="input-group mb-3">
						<label class="col-form-label col-md-3"> 跳至: </label>
						<div class="col-md-9">
							<input type="text" id="resetRetryMessageOffsetDate" class="form-control" value="${(.now?long)?number_to_datetime?string("yyyy-MM-dd HH:mm:ss")}" readonly="readonly">
						</div>
					</div>
					<div class="input-group mb-3">
						<label class="col-form-label col-md-3"> 消息key: </label>
						<div class="col-md-9">
							<input type="text" id="resetRetryMessageKey" class="form-control" placeholder="完整的key，可不填">
						</div>
					</div>
				</div>
				<div  class="modal-footer justify-content-between">
					<button type="button" data-dismiss="modal" class="btn btn-default" >取消</button>
					<button type="button" id="resetRetryMessageOffsetBtn" class="btn btn-primary" onclick="resetRetryOffset('resetRetryMessageOffsetBtn')">确定</button>
				</div>
		</div>
	</div>
</div><!-- 消息回溯-->

<!-- 消息重发确认 -->
<div id="resendMsgModal" class="modal fade" tabindex="-1" data-width="400">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">消息重发</h5>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<div class="input-group mb-3">
					<label class="col-md-3"> 消息序号: </label>
					<div class="col-md-9">
		        		<div class="form-control-static"><b id="dataIdx" style="word-break:break-all"></b></div>
					</div>
				</div>
			</div>
			<div  class="modal-footer justify-content-between">
				<button type="button" data-dismiss="modal" class="btn btn-default">取消</button>
				<button type="button" class="btn btn-primary" id="resendBtn" onclick="resendMessage()">确定</button>
			</div>
		</div>
	</div>
</div>

<#--修改consumer trace-->
<div id="updateConsumerTraceModal" class="modal fade" tabindex="-1" data-width="400">
	<div class="modal-dialog" style="width:400px;">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="consumerH4"></h5>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<div class="input-group mb-3">
					<div class="col-md-4"></div>
					<div class="col-md-8">
						<div class="form-control-static">
							<span id='traceSapn'></span> trace ?
						</div>
					</div>
				</div>
			</div>
			<div  class="modal-footer justify-content-between">
				<button type="button" data-dismiss="modal" class="btn btn-default" >取消</button>
				<button type="button" class="btn btn-primary" id="updateConsumerTraceBtn" onclick="updateConsumerTrace()">确定</button>
			</div>
		</div>
	</div>
</div> 

<!-- 暂停消费 -->
<div id="pauseConsumeConfigModel" class="modal fade" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<span class="h5"><b id="pauseConsumeTip"></b>消费</span> <a target=_blank href="${request.contextPath}/wiki/userGuide/clientConsumer#pauseConsumer" data-toggle="tooltip" data-placement="bottom" title="详细释义"><i class="fas fa-question-circle fa-sm"></i></a>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<form id="pauseConsumeConfigForm">
					<input type="hidden" id="pauseConsumeIdInput" name="consumerId">
					<input type="hidden" id="pauseConsumeBoolean" name="pause">
					<div class="input-group mb-3">
						<label class="col-form-label col-md-3"> 消费者: </label>
						<div class="col-md-9">
							<input type="text" readonly="readonly" id="pauseConsumeName" value="" class="form-control" />
						</div>
					</div>
					<div class="input-group mb-3" id="clientIdDiv" style="display: none">
						<label class="col-form-label col-md-3"> 客户端: </label>
						<div class="col-md-9">
							<div class="input-group">
								<input type="text" readonly="readonly" id="pauseClientId" name="pauseClientId" value="pauseClientId" class="form-control" />
								<div class="input-group-append" id="unregisterDiv">
									<span class="input-group-text">
										<input id="unregister" name="unregister" value="1" type="checkbox" disabled="disabled" data-toggle="tooltip" title="是否下线？勾选后消息队列将重新分配，并且不分配该客户端，后续可以恢复消费。">
									</span>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
			<div  class="modal-footer justify-content-between">
				<button type="button" data-dismiss="modal" class="btn btn-default" >取消</button>
				<button type="button" id="pauseConsumeConfigBtn" title="操作将应用到所有的消费实例" data-toggle="tooltip" class="btn btn-primary" onclick="pauseConsumeConfig()">确定</button>
			</div>
		</div>
	</div>
</div><!-- 暂停消费 -->

<!-- 消费限速 -->
<div id="limitConsumeConfigModel" class="modal fade" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<span class="h5">消费限速</span> <a target=_blank href="${request.contextPath}/wiki/userGuide/clientConsumer#limitConsumer" data-toggle="tooltip" data-placement="bottom" title="详细释义"><i class="fas fa-question-circle fa-sm"></i></a>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<form id="limitConsumeConfigForm">
					<input type="hidden" id="limitConsumeIdInput" name="consumerId">
					<div class="form-group row">
						<label class="col-form-label col-md-4"> 消费者: </label>
						<div class="col-md-8">
							<input type="text" readonly="readonly" id="limitConsumeName" value="" class="form-control" />
						</div>
					</div>
					<div class="form-group row">
						<label class="col-md-4"> 限制消费速率: </label>
						<div class="col-md-8 checkbox">
							<label data-toggle="tooltip" title="每个实例将会参照TPS进行限速">
								<input type="radio" id="enableRateLimitRadio" name="enableRateLimit" value="true" checked>是
							</label>
							<label data-toggle="tooltip" title="暂不支持关闭限速">
								<input type="radio" id="disableRateLimitRadio" name="enableRateLimit" value="false" disabled>否
							</label>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-form-label col-md-4" data-toggle="tooltip" title="消息流控，最小值为1"> TPS: </label>
						<div class="col-md-8">
							<input type="text" id="permitsPerSecondInput" data-toggle="tooltip" name="permitsPerSecond" value="${limitConsumeTps}" title="例如：${limitConsumeTps}代表每个实例每秒最多消费${limitConsumeTps}条消息" class="form-control" />
						</div>
					</div>
				</form>
			</div>
			<div  class="modal-footer justify-content-between">
				<button type="button" data-dismiss="modal" class="btn btn-default" >取消</button>
				<button type="button" id="limitConsumeBtn" class="btn btn-primary" onclick="limitConsume()">确定</button>
			</div>
		</div>
	</div>
</div>
<!-- 线程指标 -->
<div id="threadMetricsModal" class="modal fade" style="overflow-y: auto;">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<span><span id="clientIdSpan"></span>线程状况 <a href="javascript:void(0)" data-toggle="tooltip" title="刷新" onclick="threadMetrics()"><i id="redoIcon" class="fas fa-sm fa-redo-alt"></i></a></span>
				<span id="consumerGroup" style="display:none"></span>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<div class="card">
					<div class="card-body p-0 table-responsive">
						<table class="table table-striped table-sm">
							<thead>
								<tr>
									<th class="text-center" style="padding-left:0px;">序号</th>
									<th>线程堆栈</th>
									<th>消息ID列表</th>
								</tr>
							</thead>
							<tbody id="threadMetricsBody">
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- 消费失败指标 -->
<div id="failedMetricsModal" class="modal fade" style="overflow-y: auto;">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<span class="h5"><span id="failedClientIdSpan"></span>异常堆栈</span>
				<span id="failedConsumerGroup" style="display:none"></span>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<div class="card">
					<div class="card-body p-0 table-responsive">
						<table class="table table-striped table-sm">
							<thead>
								<tr class="text-sm">
									<th class="text-center" style="padding-left:0px;">序号</th>
									<th>异常堆栈</th>
									<th>消息ID列表</th>
								</tr>
							</thead>
							<tbody id="failedMetricsBody">
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- 消费时间段消息 -->
<div id="consumeTimespanMessageModel" class="modal fade" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<span class="h5">重新消费</span> <a target=_blank href="${request.contextPath}/wiki/userGuide/clientConsumer#retryTimespan" data-toggle="tooltip" data-placement="bottom" title="详细释义"><i class="fas fa-question-circle fa-sm"></i></a>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<form id="consumeTimespanMessageForm">
					<input type="hidden" id="timespanConsumeTopic" name="topic">
					<input type="hidden" id="timespanConsumerId" name="consumerId">
					<input type="hidden" id="timespanConsumeStart" name="start">
					<input type="hidden" id="timespanConsumeEnd" name="end">
					<div class="form-body">
						<div class="input-group mb-3">
							<label class="col-form-label col-md-3"> 开始时间: </label>
							<div class="col-md-9">
								<input type="text" readonly="readonly" id="timespanConsumeStartShow" class="form-control" />
							</div>
						</div>
					</div>
					<div class="form-body">
						<div class="input-group mb-3">
							<label class="col-form-label col-md-3"> 结束时间: </label>
							<div class="col-md-9">
								<input type="text" readonly="readonly" id="timespanConsumeEndShow" class="form-control" />
							</div>
						</div>
					</div>
					<div class="input-group mb-3">
						<label class="col-form-label col-md-3"> 客户端: </label>
						<div class="col-md-9">
							<select id="timespanConsumeClientIdSelect" class="selectpicker border  form-control" title="选择消费消息的实例" name="clientId">
							</select>
						</div>
					</div>
				</form>
			</div>
			<div  class="modal-footer justify-content-between">
				<button type="button" data-dismiss="modal" class="btn btn-default" >取消</button>
				<button type="button" id="submitTimespanMessageBtn" class="btn btn-primary" onclick="consumeTimespanMessage()">确定</button>
			</div>
		</div>
	</div>
</div><!-- 消费时间段消息 -->

<!-- 导出时间段消息 -->
<div id="exportTimespanMessageModel" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<span class="h5">消息导出</span>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<form id="exportTimespanMessageForm">
					<input type="hidden" id="timespanExportStart" name="start">
					<input type="hidden" id="timespanExportEnd" name="end">
					<div class="form-body">
						<div class="input-group mb-3">
							<label class="col-form-label col-md-3"> Topic: </label>
							<div class="col-md-9">
								<input type="text" readonly="readonly" name="topic" id="timespanExportTopic" class="form-control" />
							</div>
						</div>
					</div>
					<div class="form-body">
						<div class="input-group mb-3">
							<label class="col-form-label col-md-3"> 开始时间: </label>
							<div class="col-md-9">
								<input type="text" readonly="readonly" id="timespanExportStartShow" class="form-control" />
							</div>
						</div>
					</div>
					<div class="form-body">
						<div class="input-group mb-3">
							<label class="col-form-label col-md-3"> 结束时间: </label>
							<div class="col-md-9">
								<input type="text" readonly="readonly" id="timespanExportEndShow" class="form-control" />
							</div>
						</div>
					</div>
				</form>
			</div>
			<div  class="modal-footer justify-content-between">
				<button type="button" data-dismiss="modal" class="btn btn-default" >取消</button>
				<button type="button" id="submitExportMessageBtn" class="btn btn-primary" onclick="exportTimespanMessage()">确定</button>
			</div>
		</div>
	</div>
</div><!-- 导出时间段消息 -->

<!-- 消息 -->
<div id="threadMessageModal" class="modal fade">
	<div class="modal-dialog modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<span>消息查看</span>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<div class="card">
					<div class="card-body p-0 table-responsive">
						<table id="threadMessageTable" class="table table-striped table-sm" style="margin-top: 0px;word-break:break-all; word-wrap:break-all;table-layout:fixed;">
							<colgroup class="colgroup">
								<col width="35px">
								<col width="130px">
								<col width="190px">
								<col width="120px">
							</colgroup>
							<thead>
								<tr class="text-sm">
									<th class="text-center" style="padding-left:0px;">序号</th>
									<th>客户端</th>
									<th>发送时间</th>
									<th>broker:队列</th>
								</tr>
							</thead>
							<tbody>
								<tr class="no_more_data"><td colspan=4 class="text-center">暂无数据</td></tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<!-- 跳过堆积 -->
<div id="skipAccumulationModel" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">确定跳过堆积的消息吗?</h5>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<form id="skipAccumulationForm">
					<div class="input-group mb-3">
						<label class="col-form-label col-md-3"> Topic: </label>
						<div class="col-md-9">
							<input type="text" readonly="readonly" value="${topic.name}" class="form-control" />
						</div>
					</div>
					<div class="input-group mb-3">
						<label class="col-form-label col-md-3"> 消费者: </label>
						<div class="col-md-9">
							<input type="text" readonly="readonly" id="skipAccumulationConsumer" class="form-control" />
						</div>
					</div>
					<input type="hidden" name="tid" value="${topic.id}">
					<input type="hidden" name="consumerId" id="skipAccumulationConsumerId">
					<input type="hidden" name="cid" value="${topic.clusterId}">
				</form>
			</div>
			<div  class="modal-footer justify-content-between">
				<button type="button" data-dismiss="modal" class="btn btn-default" >取消</button>
				<button type="button" id="skipAccumulationBtn" class="btn btn-primary" onclick="skipAccumulation()">确定</button>
			</div>
		</div>
	</div>
</div><!-- 跳过堆积结束 -->

<!-- 消息回溯-->
<div id="resetOffsetModel" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">消息回溯</h5>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<form id="resetOffsetForm">
					<div class="input-group mb-3">
						<label class="col-form-label col-md-3"> Topic: </label>
						<div class="col-md-9">
							<input type="text" readonly="readonly" value="${topic.name}" class="form-control" />
						</div>
					</div>
					<div class="input-group mb-3">
						<label class="col-form-label col-md-3"> 消费者: </label>
						<div class="col-md-9">
							<input type="text" readonly="readonly" id="resetOffsetConsumer" class="form-control" />
						</div>
					</div>
					<div class="input-group mb-3">
						<label class="col-form-label col-md-3"> 回溯到: </label>
						<div class="col-md-9">
							<div class="input-group date" id="resetOffsetDate" data-target-input="nearest">
								<input type="text" id="resetOffsetDateInput" name="offset" class="form-control datetimepicker-input" data-target="#resetOffsetDate"/>
								<div class="input-group-append" data-target="#resetOffsetDate" data-toggle="datetimepicker">
									<div class="input-group-text"><i class="far fa-clock"></i></div>
								</div>
							</div>
						</div>
					</div>
					<input type="hidden" name="tid" value="${topic.id}">
					<input type="hidden" name="consumerId" id="resetOffsetConsumerId">
					<input type="hidden" name="cid" value="${topic.clusterId}">
				</form>
			</div>
			<div  class="modal-footer justify-content-between">
				<button type="button" data-dismiss="modal" class="btn btn-default" >取消</button>
				<button type="button" id="resetOffsetBtn" class="btn btn-primary" onclick="resetOffset()">确定</button>
			</div>
		</div>
	</div>
</div><!-- 消息回溯-->

<!-- 删除consumer -->
<div id="deleteConsumerModel" class="modal fade">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">确定删除消费者吗?</h5>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<form id="deleteConsumerForm">
					<div class="input-group mb-3">
						<label class="col-form-label col-md-3"> Topic: </label>
						<div class="col-md-9">
							<input type="text" readonly="readonly" value="${topic.name}" class="form-control" />
						</div>
					</div>
					<div class="input-group mb-3">
						<label class="col-form-label col-md-3"> 消费者: </label>
						<div class="col-md-9">
							<input type="text" readonly="readonly" id="deleteConsumerName" class="form-control" />
						</div>
					</div>
					<input type="hidden" name="tid" value="${topic.id}">
					<input type="hidden" name="consumerId" id="deleteConsumerId">
				</form>
			</div>
			<div  class="modal-footer justify-content-between">
				<button type="button" data-dismiss="modal" class="btn btn-default" >取消</button>
				<button type="button" id="deleteConsumerBtn" class="btn btn-primary" onclick="deleteConsumer()">确定</button>
			</div>
		</div>
	</div>
</div>

<!-- 客户端实时信息 -->
<div id="consumerRunningInfoModel" class="modal fade"  style="overflow-y: auto;">
	<div class="modal-dialog  modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title"><span id="consumerRunningInfoClientIdSpan"></span>实时消费状况</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body" id="consumerRunningInfoModelBody">
			</div>
		</div>
	</div>
</div>

<!-- 客户端状况统计 -->
<div id="consumerStatsModal" class="modal fade"  style="overflow-y: auto;">
	<div class="modal-dialog  modal-xl">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="consumerStatsTitle"></h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div id="consumerStatsChart"></div>
			</div>
		</div>
	</div>
</div>

<!-- http消费配置 -->
<div id="httpConfigModel" class="modal fade" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<span class="h5">HTTP消费配置</span>
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
			</div>
			<div class="modal-body">
				<form id="httpConsumeConfigForm">
					<input type="hidden" name="consumerId" id="httpConsumerId">
					<div class="form-group row">
						<label class="col-form-label col-md-4"> 消费者: </label>
						<div class="col-md-8">
							<input type="text" readonly="readonly" id="httpConsumeName" name="consumer" value="" class="form-control" />
						</div>
					</div>
					<div class="form-group row">
						<label class="col-form-label col-md-4"> 每次请求最多拉取: </label>
						<div class="col-md-8">
							<div class="input-group">
								<input type="text" id="pullSizeInput" data-toggle="tooltip" name="pullSize" title="最小为1，最大为128，非必要请勿修改" class="form-control" />
								<div class="input-group-append">
									<span class="input-group-text">条消息</span>
								</div>
							</div>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-form-label col-md-4"> 请求拉取超时时间: </label>
						<div class="col-md-8">
							<div class="input-group">
								<input type="text" id="pullTimeoutInput" data-toggle="tooltip" name="pullTimeout" title="最小为1秒，最大为60秒，非必要请勿修改" class="form-control" />
								<div class="input-group-append">
									<span class="input-group-text">秒</span>
								</div>
							</div>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-form-label col-md-4"> 消费超时时间: </label>
						<div class="col-md-8">
							<div class="input-group">
								<input type="text" id="consumeTimeoutInput" data-toggle="tooltip" name="consumeTimeout" title="最小为10秒，最大为36小时，非必要请勿修改" class="form-control" />
								<div class="input-group-append">
									<span class="input-group-text">秒</span>
								</div>
							</div>
						</div>
					</div>
				</form>
			</div>
			<div  class="modal-footer justify-content-between">
				<button type="button" data-dismiss="modal" class="btn btn-default" >取消</button>
				<button type="button" id="httpConsumeBtn" class="btn btn-primary" onclick="httpConsumeConfig()">确定</button>
			</div>
		</div>
	</div>
</div>

<#include "../inc/pagination.html">
<script>
/**
 * 限制消费速率
 */
function showLimitConsumeConfigModel(consumerId, consumer, enableRateLimit, permitsPerSecond){
	$("#limitConsumeConfigForm")[0].reset();
	// if(enableRateLimit){
	// 	$("#enableRateLimitRadio").prop("checked",true);
	// } else {
	// 	$("#disableRateLimitRadio").prop("checked",true);
	// }
	if(permitsPerSecond){
		$("#permitsPerSecondInput").val(permitsPerSecond);
	}
	$("#limitConsumeIdInput").val(consumerId);
	$("#limitConsumeName").val(consumer);
	$("#limitConsumeConfigModel").modal('show');
}
/**
 * 暂停恢复消费者
 */
function showPauseConsumeConfigModel(consumerId, consumer, pause, comp){
	if (pause) {
		$("#pauseConsumeTip").html("暂停");
	} else {
		$("#pauseConsumeTip").html("恢复");
	}
	if (comp) {
		var clientId = comp.getAttribute("data-clientId");
		if (!clientId) {
			alert("没有获取客户端链接无法进行操作");
			return;
		}
		$("#clientIdDiv").show();
		$("#pauseClientId").val(clientId);
		if (pause) {
			$("#unregister").removeAttr("disabled");
		} else {
			$("#unregister").prop("checked", false);
			$("#unregister").attr("disabled", "disabled");
		}
		if (comp.hasAttribute("id")) {
			$("#unregisterDiv").show();
		} else {
			$("#unregisterDiv").hide();
		}
	} else {
		$("#clientIdDiv").hide();
		$("#pauseClientId").val("");
	}
	$("#pauseConsumeBoolean").val(pause);
	$("#pauseConsumeIdInput").val(consumerId);
	$("#pauseConsumeName").val(consumer);
	$("#pauseConsumeConfigModel").modal('show');
}
/**
 * 暂停消费
 */
function pauseConsumeConfig(){
	disable("pauseConsumeConfigBtn");
	$.get('${request.contextPath}/consumer/update/config',
	$("#pauseConsumeConfigForm").serialize()
	,function(data){
        if(data.status == 200){
			toastr.success("申请成功，请稍后查看！即将跳转到我的工单");
			toMyAuditPage();
	    }else{
	    	toastr.error("操作失败！"+data.message);  
	    	enable("pauseConsumeConfigBtn");
	    }
    }, 'json');
}

/**
 * 限速
 */
function limitConsume(){
	var tps = Number($("#permitsPerSecondInput").val());
	if(tps < 1){
		alert("tps不能小于1");
		return;
	}
	if(!Number.isInteger(tps)){
		alert("tps只能为正整数");
		return;
	}
	disable("limitConsumeBtn");
	$.get('${request.contextPath}/consumer/update/config',
	$("#limitConsumeConfigForm").serialize()
	,function(data){
        if(data.status == 200){
			toastr.success("申请成功，请稍后查看！即将跳转到我的工单");
			toMyAuditPage();
	    }else{
	    	toastr.error("操作失败！"+data.message);  
	    	enable("limitConsumeBtn");
	    }
    }, 'json');
}

function showUpdateInfo(cid, consumer, info){
	$("#currentConsumerID").val(cid);
	$("#consumerTitle").html(consumer);
	$("#consumerInfo").val(info);
	$("#updateConsumerInfoModal").modal('show');
}

function showResetRetryMessageOffsetModel(consumerId, consumer){
	$("#resetRetryMessageOffsetConsumer").val(consumer);
	$("#resetRetryMessageOffsetConsumerId").val(consumerId);
	$("#resetRetryMessageOffsetModel").modal('show');
}
/**
 * 重置重试偏移量
 */
function resetRetryOffset(btn){
	disable(btn);
	$.get('${request.contextPath}/consumer/skip/retryOffset',{
		tid: ${RequestParameters.tid},
		consumerId: $("#resetRetryMessageOffsetConsumerId").val(),
		offset: $("#resetRetryMessageOffsetDate").val(),
		cid: $("#toCid").val(),
		messageKey: $("#resetRetryMessageKey").val()
	},function(data){
        if(data.status == 200){
			toastr.success("申请成功，请稍后查看！即将跳转到我的工单");
			toMyAuditPage();
	    }else{
	    	toastr.error("操作失败！"+data.message);  
	    	enable(btn);
	    }
    }, 'json');
}

function skipAccumulationShow(consumer, consumerId){
	$("#skipAccumulationConsumer").val(consumer);
	$("#skipAccumulationConsumerId").val(consumerId);
	$("#skipAccumulationModel").modal('show');
}
/**
 * 跳过堆积
 */
function skipAccumulation(){
	disable("skipAccumulationBtn");
	$.get('${request.contextPath}/consumer/resetOffset', $("#skipAccumulationForm").serialize() ,function(data){
        if(data.status == 200){
			toastr.success("申请成功，请稍后查看！即将跳转到我的工单");
			toMyAuditPage();
	    }else{
	    	toastr.error("操作失败！"+data.message);  
	    	enable("skipAccumulationBtn");
	    }
    }, 'json');
}

function resetOffsetShow(consumer, consumerId) {
	$("#resetOffsetConsumer").val(consumer);
	$("#resetOffsetConsumerId").val(consumerId);
	$("#resetOffsetModel").modal('show');
}

/**
 * 重置偏移量
 */
function resetOffset(){
	var resetOffsetTo = $("#resetOffsetDateInput").val();
	if(!resetOffsetTo){
		alert("请选择回溯到的时间!");
		return;
	}
	disable("resetOffsetBtn");
	$.get('${request.contextPath}/consumer/resetOffset', $("#resetOffsetForm").serialize(),function(data){
        if(data.status == 200){
			toastr.success("申请成功，请稍后查看！即将跳转到我的工单");
			toMyAuditPage();
	    }else{
	    	toastr.error("操作失败！"+data.message);  
	    	enable("resetOffsetBtn");
	    }
    }, 'json');
}

function deleteConsumerShow(consumer, consumerId){
	$("#deleteConsumerName").val(consumer);
	$("#deleteConsumerId").val(consumerId);
	$("#deleteConsumerModel").modal('show');
}

/**
 * 删除消费者
 */
function deleteConsumer(){
	disable("deleteConsumerBtn");
	$.post('${request.contextPath}/consumer/delete', $("#deleteConsumerForm").serialize(), function(data){
        if(data.status == 200){
			toastr.success("申请成功，请稍后查看！即将跳转到我的工单");
			toMyAuditPage();
	    }else{
	    	toastr.error("操作失败！"+data.message);  
	    	enable("deleteConsumerBtn");
	    }
    }, 'json');
}

$(function(){
	 //添加删除特效
    $(".producer_delete").hover(function(){
    	$(this).addClass("text-delete");
    },function(){
    	$(this).removeClass("text-delete");
    });
 	// 初始化user列表
	initUserList('user_search_select');
 	// search type tooltip
	$("#searchCondition").selectpicker().on('changed.bs.select', function(){
 	  	changeSearchType($('#searchCondition option:selected').val());
 	});
 	$("#timespanConsumeClientIdSelect").selectpicker().on('changed.bs.select', function(){
 	  	$('#submitTimespanMessageBtn').removeAttr("disabled");
 	});

	$('#resetOffsetDate').datetimepicker({
		format: 'YYYY-MM-DD HH:mm:ss',
		minDate: moment({h:0, m:0, s:0, ms:0}).subtract(${cluster.fileReservedDays}, 'days'),
		maxDate: '${.now?string("yyyy-MM-dd HH:mm:ss")}',
		defaultDate: '${.now?string("yyyy-MM-dd HH:mm:ss")}',
		icons: { time: 'far fa-clock' },
		focusOnShow: false
	});
	$("#timeStartTimePicker").datetimepicker({
		format: 'YYYY-MM-DD HH:mm:ss',
		minDate: moment({h:0, m:0, s:0, ms:0}).subtract(${cluster.fileReservedDays}, 'days'),
		maxDate: '${.now?string("yyyy-MM-dd HH:mm:ss")}',
		icons: { time: 'far fa-clock' },
		focusOnShow: false
	});
	$("#timeStartTimePickerInput").val('${(.now?long-300000)?number_to_datetime?string("yyyy-MM-dd HH:mm:ss")}');
	$("#timeStartTimePicker").on("change.datetimepicker", function (e) {
		timeChange("timeStartTime");
	});
	$("#keyStartTimePicker").datetimepicker({
		format: 'YYYY-MM-DD HH:mm:ss',
		minDate: moment({h:0, m:0, s:0, ms:0}).subtract(${cluster.fileReservedDays}, 'days'),
		maxDate: '${.now?string("yyyy-MM-dd HH:mm:ss")}',
		icons: { time: 'far fa-clock' },
		focusOnShow: false
	});
	$("#keyStartTimePickerInput").val('${.now?string("yyyy-MM-dd 00:00:00")}');
	$("#keyStartTimePicker").on("change.datetimepicker", function (e) {
		timeChange("keyStartTime");
	});
	var endTimeOption = {
		format: 'YYYY-MM-DD HH:mm:ss',
		minDate: moment({h:0, m:0, s:0, ms:0}).subtract(${cluster.fileReservedDays}, 'days'),
		maxDate: '${.now?string("yyyy-MM-dd HH:mm:ss")}',
		defaultDate: '${.now?string("yyyy-MM-dd HH:mm:ss")}',
		icons: { time: 'far fa-clock' },
		focusOnShow: false
	};
	$("#timeEndTimePicker").datetimepicker(endTimeOption);
	$("#timeEndTimePicker").on("change.datetimepicker", function (e) {
		timeChange("timeEndTime");
	});
	$("#keyEndTimePicker").datetimepicker(endTimeOption);
	$("#keyEndTimePicker").on("change.datetimepicker", function (e) {
		timeChange("keyEndTime");
	});

	//初始化key查询方式的时间
	timeChange('keyStartTime');

	// fix bootstrap model & highcharts resize
	$('#consumerStatsModal').on('shown.bs.modal', function() {
		consumerStats();
	});

	<#if response.OK>
		lineChart("consume", function (){
			$("#tid").val("${RequestParameters.tid}");
			<#if RequestParameters.consumer??>
				$("#_consumer").val("${RequestParameters.consumer}");
			</#if>
			<#if RequestParameters.currentPage??>
				$("#currentPage").val(${RequestParameters.currentPage});
			</#if>
		});
		<#if RequestParameters.consumer?? && RequestParameters.consumer != "">
			$('a[data="${RequestParameters.consumer}"]').click();
			if (getQueryString("consumerId")) {
				showResetRetryMessageOffsetModel(getQueryString("consumerId"), "${RequestParameters.consumer}");
			} else if (getQueryString("time")) {
				$("#msgSearchModal").on('show.bs.modal', function () {
					$("#dataTable tbody").html("<tr class='no_more_data'><td colspan=6 class='text-center'><i class='fa-solid fa-spinner fa-spin fa-lg'></i></td></tr>");
					searchByTime(getQueryString("time"));
				})
				$("#${RequestParameters.consumer}").click();
			}
		</#if>
	</#if>
});

function timeChange(id){
	var dt = $("#" + id + "PickerInput").val();
	var tm = parseDate(dt);
	$("#" + id).val(tm);
}
//准备删除
function prepareDeleteUserConsumer(uid,userName,consumerID){
	$("#user_name").val(userName);
	$("#currentUid").val(uid);
	$("#currentCid").val(consumerID);
	$("#deleteUserConsumerModal").modal('show');
}
//删除用户与消费者关联
function deleteUserConsumer(){
	disable("deleteUserConsumerBtn");
	$.post('${request.contextPath}/userConsumer/delete',
		{
			uid: $("#currentUid").val(),
			cid: $("#currentCid").val()
		},
        function(data){
            if(data.status == 200){
				toastr.success("申请成功，请稍后查看！即将跳转到我的工单");
				toMyAuditPage();
		    }else{
		    	toastr.error("删除失败！"+data.message);  
		    	enable("deleteUserConsumerBtn");
		    }
    }, 'json');
}
/**
 * 初始化user下拉列表
 */
function initUserList(componentId){
	$.post('${request.contextPath}/user/list',
	        function(data){
	            if(data.status == 200){
	            	var content = "";
	            	for(var i in data.result){
	            		var user = data.result[i];
	            		var value = user.email.substring(0, user.email.indexOf("@"));
	            		if(user.name && user.name != value){
	            			value = user.name + "【" + value +"】";
	            		}
	            		content += "<option value='"+user.id+"'>"+value+"</option>";	
	            	}
	        		$("#"+componentId).html(content);
	        		$("#"+componentId).selectpicker('refresh');
			    }else{
			    	toastr.error("数据获取失败！"+data.message);  
			    }
        }, 'json');
}
//关联用户
function associateUserConsumer(consumerGroupID,consumerGroupName){
	$("#topicName").val('${topic.name}');
	$("#consumerGroupName").val(consumerGroupName);
	$("#consumerGroupID").val(consumerGroupID);
	$("#addUserConsumerModal").modal('show');
}
/**
 * 发送添加用户请求
 */
function addUserCounsumerRelationship(){
	if(!$("#user_search_select").val()){
		alert("请先选择用户");
		return;
	}
	disable("associateUserConsumerBtn");
	$.post('${request.contextPath}/consumer/auth/associate',
			{
				cid: $("#consumerGroupID").val(),
				tid: $("#tid").val(),
				uid: $('#user_search_select option:selected').val(),
			},
	        function(data){
	            if(data.status == 200){
					toastr.success("申请成功，请稍后查看！即将跳转到我的工单");
					toMyAuditPage();
			    }else{
			    	toastr.error("申请失败！"+data.message);  
			    	enable("associateUserConsumerBtn");
			    }
	    }, 'json');
}

//当前消息搜索时的topic
var currentSelectTopic = '';
var queueOffsetMap = null;
function brokerNameSelectChange(obj){
	var value = obj.options[obj.selectedIndex].value;
	if (value == "all"){
		$("#queueSearchSelect").html("<option value='-1'>全部队列</option>");
		$("#queueSearchSelect").selectpicker('refresh');
		$("#offsetStart").val(minAllOffset);
		$("#offsetEnd").val(maxAllOffset);
		return;
	}
	resetMaxOffsetByBrokerName(value);
	$.get('${request.contextPath}/consumer/broker/queue',
			{
				topic: currentSelectTopic,
				brokerName: value,
				clusterId : $("#toCid").val()
			},
	        function(data){
	            if(data.status == 200){
	            	queueOffsetMap = data.result;
	            	var content = "<option value='-1'>全部队列</option>";
	            	for (var  key in queueOffsetMap){
	            		content += "<option value='"+key+"'>"+key+"</option>";
	            	}
	            	$("#queueSearchSelect").html(content);
	            	$("#queueSearchSelect").selectpicker('refresh');
			    }
	    }, 'json');
}
var maxAllOffset = '';
var minAllOffset = '';
function initOffsetMsgModal(type, index, topic, consumerId, consumer, maxOffset, traceEnabled){
	// 清空数据
	$("#dataTable tbody").html("<tr class='no_more_data'><td colspan=6 class='text-center'>暂无数据</td></tr>");
	$("#toTopic").val(topic);
	$("#messageConsumerId").val(consumerId);
	$("#messageConsumer").val(consumer);
	$("#pager").hide();
	
	// 计算offset
	var start = maxOffset - 100;
	if(start < 0){
		start = 0;
	}
	maxAllOffset = maxOffset;
	minAllOffset = start;
	currentSelectTopic = topic;
	$("#offsetStart").val(start);
	$("#offsetEnd").val(maxOffset);
	$("#toKey").val("");
	$("#traceEnabled").val(traceEnabled);
	
	if(type == "dlq") {
		$(".resendMessageBtn").show();
		$("#consumeTimespanMessageBtn").addClass("time");
		$("#exportTimespanMessageBtn").addClass("time");
		$("#cosumeTimes").html("消费次数");
		if(prevSearchType == "time"){
			$("#consumeTimespanMessageBtn").show();
			$("#exportTimespanMessageBtn").show();
		}
		$("#checkInput").show();
		$("#msgTypeSpan").html("死信");
	} else {
		$(".resendMessageBtn").hide();
		$("#consumeTimespanMessageBtn").hide().removeClass("time");
		$("#cosumeTimes").html("重试次数");
		$("#checkInput").hide();
		$("#exportTimespanMessageBtn").hide().removeClass("time");
		$("#msgTypeSpan").html("重试");
	}
	//初始化broker列表
 	initBrokerList('brokerNameSearchSelect');
 	$("#queueSearchSelect").selectpicker('refresh');
}
//偏移量消息搜索
function searchOffsetMessage(append){
	$("#toAppend").val(append);
	post('${request.contextPath}/topic/message/retry/search/offset', $("#msgSearchForm").serialize(), function(data){
		if(!append){
			$("#dataTable tbody").remove();
		}
       	$("#dataTable").append(data);
    });
}

var pageNum = 0;
//显示分页
function showPage(num){
	pageNum = num;
	var comp = $("#data_"+num);
	var size = comp.attr("data_size");
	var search = comp.attr("data_search");
	var left = comp.attr("data_left");
	$("#pageNum").html(num);
	$("#sizeNum").html(size);
	$("#searchNum").html(search);
	$("#leftNum").html(left);
	$("#pager").show();
	if(num == 1){
		$("#previous").addClass("disabled");
	} else {
		$("#previous").removeClass("disabled");
	}
	if(left > 0){
		$("#next").removeClass("disabled");
	} else {
		$("#next").addClass("disabled");
	}
	// 展示数据
	$("#page_"+pageNum).show().siblings("tbody").hide();
}
//上一页
function previous(){
	if(!$("#previous").hasClass("disabled")){
		showPage(pageNum - 1);
	}
}
//下一页
function next(){
	if(!$("#next").hasClass("disabled")){
		if($("#data_"+(pageNum+1)).length > 0){
			showPage(pageNum+1);
		} else {
			if($("#offsetStart").is(":visible")){
				searchOffsetMessage(true);
			} else {
				searchMessage(true);
			}
		}
	}
}
/**
 * 初始化broker下拉列表
 */
var brokerNameMap = null;
function initBrokerList(componentId){
	$.get('${request.contextPath}/topic/brokerName/list',
			{
				topic: currentSelectTopic,
				clusterId : $("#toCid").val()
			},
	        function(data){
	            if(data.status == 200){
	            	brokerNameMap = data.result;
	            	var content = "<option value='all'>全部broker</option>";
	            	for (var key in brokerNameMap){
	            		content += "<option value='"+key+"'>"+key+"</option>";
	            	}
	        		$("#"+componentId).html(content);
	        		$("#"+componentId).selectpicker('refresh');
			    }else{
			    	toastr.error("数据获取失败！"+data.message);  
			    }
        }, 'json');
}
function queueSelectChange(obj){
	var value = obj.options[obj.selectedIndex].value;
	var queue = parseInt(value);
	if (queue == -1){
		resetMaxOffsetByBrokerName($("#brokerNameSearchSelect").val());
		return;
	}
	resetMaxOffset(queue, 'queue');
}
//重置偏移量
function resetMaxOffsetByBrokerName(key){
	if (brokerNameMap != null){
		resetMaxOffset(key,'broker');
	}
}
function resetMaxOffset(key,type){
	var max = null;
	if (type == 'broker'){
		max = brokerNameMap[key];
	}else{
		max = queueOffsetMap[key];
	}
	
	var min = max - 100;
	if (min < 0){
		min = 0;
	}
	$("#offsetStart").val(min);
	$("#offsetEnd").val(max);
}

// 获取队列客户端ip
var queueOwnerInitArray = new Array();
function getQueueOwner(consumer, consumerId){
	if(queueOwnerInitArray[consumerId]){
		return;
	}
	$.get('${request.contextPath}/consumer/queue/owner',{
		cid: $("#toCid").val(),
		consumer: consumer
	},function(data){
        if(data.status == 200){
        	for(var i in data.result){
        		var id = "#" + data.result[i].topicType + "_" + consumerId + "_" + data.result[i].brokerName + "_" + data.result[i].queueId;
				var prevTitle = $(id).attr("title");
				if (prevTitle) {
					prevTitle += "<br/>"
				} else {
					prevTitle = "";
				}
				if (data.result[i].showClientInfo) {
					$(id).addClass("text-primary pointer");
					if (data.result[i].hasOwnProperty('warnInfo')) {
						$(id).addClass("bg-warning");
						$(id).attr("title", prevTitle + data.result[i].warnInfo);
						if (data.result[i].consumeFailed) {
							$(id + "_excption").addClass("bg-warning");
						}
						if (data.result[i].flowControlled) {
							$(id + "_thread").addClass("bg-warning");
						}
					} else {
						$(id).attr("title", prevTitle + "查看" + data.result[i].language + ":" + data.result[i].clientId + "详情");
					}
				} else {
					$(id).attr("title", prevTitle + data.result[i].clientId);
				}
				var prevContent = $(id).html();
				if (prevContent) {
					prevContent += "<br/>"
				}
				$(id).attr("clientId", data.result[i].clientId);
				$(id).html(prevContent + data.result[i].ip);
				$(id).attr("data-html", "true");
				$(id).attr("data-placement", "right");
				$(id).tooltip({boundary: 'window'});
				// 设置是否暂停
				if (data.result[i].paused) {
					if(data.result[i].disablePause){
						$(id + "_resume").attr("disabled", "disabled").show();
					} else {
						$(id + "_resume").attr("data-clientId", data.result[i].clientId).show();
					}
				} else {
					$(id + "_pause").attr("data-clientId", data.result[i].clientId).show();
				}
        	}
	    }else{
	    	toastr.error("获取客户端失败！"+data.message);  
	    }
        queueOwnerInitArray[consumerId] = true;
    }, 'json');
}

// 更新consumer用途
function updateConsumerInfo(){
	if(!$("#consumerInfo").val()){
		alert("请输入用途");
		return;
	}
	disable("updateConsumerInfoBtn");
	$.post('${request.contextPath}/consumer/update/info',
			{
				info: $("#consumerInfo").val(),
				cid: $("#currentConsumerID").val()
			},
	        function(data){
	            if(data.status == 200){
	            	toastr.success("操作成功！即将刷新页面！");  	            	
	            	reload(2000);            	
			    }else{
			    	toastr.error("操作失败！"+data.message);  
			    	enable("updateConsumerInfoBtn");
			    }
	    }, 'json');
}

//重发消息 提示
function resendMessageTip(){
	var dataIdxArray = new Array();
	$('#dataTable tbody input[type=checkbox]:checked').each(function(){
		var dataIdx = $(this).attr("dataIdx");
		if(dataIdx){
			dataIdxArray.push(dataIdx);
		}
	});
	if(dataIdxArray.length == 0) {
		alert("请先选择消息");
		return;
	}
	$("#dataIdx").html(dataIdxArray.toString());
	$('#resendMsgModal').modal('show');
}

//重发消息 
function resendMessage(){
	var dataArray = new Array();
	$('#dataTable tbody input[type=checkbox]:checked').each(function(){
		dataArray.push($(this).attr("data"));
	});
	if(dataArray.length == 0) {
		alert("请先选择消息");
		return;
	}
	disable("resendBtn");
	$.post('${request.contextPath}/topic/message/resend',
		{
			msgIds: dataArray.toString(),
			tid: ${RequestParameters.tid},
			cid: $("#messageConsumerId").val()
		},
        function(data){
            if(data.status == 200){
				toastr.success("申请成功，请稍后查看！即将跳转到我的工单");
				toMyAuditPage();
		    }else{
		    	toastr.error("申请失败！"+data.message);
				enable("resendBtn");
		    }
    }, 'json');
}

//时间段消费 提示
function consumeTimespanMessageTip(){
	$("#consumeTimespanMessageBtn").attr("disabled", "disabled");
	$.get('${request.contextPath}/consumer/connection',{
		group: $("#messageConsumer").val(),
		cid: ${topic.clusterId},
	},function(data){
         if(data.status == 200){
          	var content = "";
          	for(var i in data.result){
          		var ip = data.result[i];
         		content += "<option value='"+ip+"'>"+ip+"</option>";
          	}
      		$("#timespanConsumeClientIdSelect").html(content);
      		$("#timespanConsumeClientIdSelect").selectpicker('refresh');
	    } else {
	    	toastr.error("数据获取失败！"+data.message);
	    }
    }, 'json');
    $("#consumeTimespanMessageBtn").removeAttr("disabled");
	$("#timespanConsumeTopic").val($("#toTopic").val());
	$("#timespanConsumerId").val($("#messageConsumerId").val());
	$("#timespanConsumeStartShow").val($("#timeStartTimePickerInput").val());
	$("#timespanConsumeEndShow").val($("#timeEndTimePickerInput").val());
	$("#timespanConsumeStart").val($("#timeStartTime").val());
	$("#timespanConsumeEnd").val($("#timeEndTime").val());
	$('#submitTimespanMessageBtn').attr("disabled", "disabled");
	$("#consumeTimespanMessageModel").modal('show');
}

//时间段消费
function consumeTimespanMessage(){
	disable("submitTimespanMessageBtn");
	post('${request.contextPath}/consumer/timespanMessageConsume', 
		$("#consumeTimespanMessageForm").serialize(), 
		function(data){
	        if(data.status == 200){
				toastr.success("申请成功，请稍后查看！即将跳转到我的工单");
				toMyAuditPage();
		    }else{
		    	toastr.error("操作失败！"+data.message);  
		    	enable("submitTimespanMessageBtn");
		    }
    	}, 'json');
}

//时间段消息导出 提示
function exportTimespanMessageTip(){
	$("#timespanExportTopic").val($("#toTopic").val());
	$("#timespanExportStartShow").val($("#timeStartTimePickerInput").val());
	$("#timespanExportEndShow").val($("#timeEndTimePickerInput").val());
	$("#timespanExportStart").val($("#timeStartTime").val());
	$("#timespanExportEnd").val($("#timeEndTime").val());
	$("#exportTimespanMessageModel").modal('show');
}

//时间段消息导出
function exportTimespanMessage(){
	disable("submitExportMessageBtn");
	post('${request.contextPath}/topic/message/export', $("#exportTimespanMessageForm").serialize(), function(data){
		if(data.status == 200){
			toastr.success("申请成功，请稍后查看！即将跳转到我的工单");
			toMyAuditPage();
		}else{
			toastr.error("操作失败！"+data.message);
			enable("submitExportMessageBtn");
		}
	}, 'json');
}

function updateConsumerTraceShow(cid, consumer, traceable){
	$("#consumerH4").val(cid);
	$("#consumerH4").html(consumer);
	if(traceable == 1) {
		$("#traceSapn").html("关闭");
		$("#traceSapn").val(0);
	} else {
		$("#traceSapn").html("开启");
		$("#traceSapn").val(1);
	}
	$('#updateConsumerTraceModal').modal('show');
}
function updateConsumerTrace(){
	disable("updateConsumerTraceBtn");
	$.post('${request.contextPath}/consumer/update/_trace',
			{
				cid: $("#consumerH4").val(),
				traceEnabled: $("#traceSapn").val()
			},
	        function(data){
	            if(data.status == 200){
	            	toastr.success("修改成功！请重启应用！");  	            	
	            	reload(2000);            	
			    }else{
			    	toastr.error("操作失败！"+data.message);  
			    	enable("updateConsumerTraceBtn");
			    }
	    }, 'json');
}

//更改搜素选项
var prevSearchType = "key";
function changeSearchType(type, removeTBody){
	// 无改变
	if(prevSearchType == type){
		return;
	}
	if (removeTBody == undefined) {
		removeTBody = true;
	}
	$("."+type).show();
	if(prevSearchType) {
		$("."+prevSearchType).hide();
	}
	prevSearchType = type;
	
	$("#pager").hide();
	hideAndResetBrokerSelect();
	// 清空数据
	if (removeTBody) {
		$("#dataTable tbody").remove();
		$("#dataTable").append("<tbody><tr class='no_more_data'><td colspan=6 class='text-center'>暂无数据</td></tr></tbody>");
	}
}

function hideAndResetBrokerSelect(){
	//重置broker下拉框状态
    $("#brokerNameSearchSelect").selectpicker('val', "all");
    $("#queueSearchSelect").selectpicker('val', "-1");
}

//消息搜索
function searchMessage(append){
	$("#toAppend").val(append);
	post('${request.contextPath}/topic/message/retry/search/time', $("#msgSearchForm").serialize(), function(data){
		if(!append){
			$("#dataTable tbody").remove();
		}
       	$("#dataTable").append(data);
    });
}
//消息key搜索
function searchKeyMessage() {
	if(!$("#msgKey").val()){
		alert("消息key不能为空");
		return;
	}
	post('${request.contextPath}/topic/message/retry/search/key', $("#msgSearchForm").serialize(), function(data){
		$("#dataTable tbody").remove();
       	$("#dataTable").append(data);
    });
}

function showThreadMetricsForClustering(ipId, consumer){
	var clientId = $("#"+ipId).attr("clientId");
	if(!clientId){
		alert("客户端链接不存在");
		return;
	}
	showThreadMetrics(clientId, consumer);
}

function showThreadMetrics(clientId, consumer){
	$("#clientIdSpan").html(clientId);
	$("#consumerGroup").html(consumer);
	$("#threadMetricsBody").html("<tr><td colspan='3' align='center'>暂无数据</td><tr>");
	$('#threadMetricsModal').modal('show');
	threadMetrics();
}

function threadMetrics(){
	$("#redoIcon").addClass("fa-spin");
	post('${request.contextPath}/consumer/threadMetrics',
		{
			clientId: $("#clientIdSpan").html(),
			consumer: $("#consumerGroup").html()
		}, function(data){
			$("#redoIcon").removeClass("fa-spin");
			$("#threadMetricsBody").html(data);
	});
}

function toggleThreadStack(comp){
	$(comp).nextAll().toggle(250);
	if($(comp).children("span").hasClass("fa-caret-right")){
		$(comp).children("span").removeClass("fa-caret-right").addClass("fa-caret-down");
	} else {
		$(comp).children("span").removeClass("fa-caret-down").addClass("fa-caret-right");
	}
}

function showThreadMessage(msgId){
	$('#threadMessageModal').modal('show');
	$.post('${request.contextPath}/topic/message/thread/message',
		{
			cid: ${topic.clusterId},
			topic: '${topic.name}',
			msgId: msgId
		},
		function(data){
			$("#threadMessageTable tbody").remove();
	       	$("#threadMessageTable").append(data);
	});
}

// 按照时间查询
function searchByTime(time){
	var start = time - 2 * 60 * 60 * 1000;
	var end = time + 60 * 60 * 1000;
	var now = new Date().getTime();
	if(end > now){
		end = now;
	}
	start = formatDateYMDHM(start);
	end = formatDateYMDHM(end);
	// 修改时间
	$("#timeStartTimePickerInput").val(start);
	$("#timeEndTimePickerInput").val(end);
	timeChange('timeStartTime');
	timeChange('timeEndTime');
	// 更改查询方式为时间
	$("#searchCondition").selectpicker('val', "time");
	changeSearchType('time', false);
	// 查询时间
	searchMessage(false);
}

function showFailedMetricsForClustering(ipId, consumer){
	var clientId = $("#"+ipId).attr("clientId");
	if(!clientId){
		alert("客户端链接不存在");
		return;
	}
	showFailedMetrics(clientId, consumer);
}

function showFailedMetrics(clientId, consumer){
	$("#failedClientIdSpan").html(clientId);
	$("#failedConsumerGroup").html(consumer);
	$("#failedMetricsBody").html("<tr><td colspan='3' align='center'>暂无数据</td><tr>");
	$('#failedMetricsModal').modal('show');
	failedMetrics();
}

function failedMetrics(){
	post('${request.contextPath}/consumer/failedMetrics',
		{
			clientId: $("#failedClientIdSpan").html(),
			consumer: $("#failedConsumerGroup").html()
		}, function(data){
		$("#failedMetricsBody").html(data);
	});
}

function toggleMsgCheck(box) {
	$('#dataTable tbody:visible input[type=checkbox]').each(function () {
		if (box.checked) {
			$(this).prop('checked', true);
		} else {
			$(this).prop('checked', false);
		}
	});
}

var curConsumer;
function showConsumerStats(consumer){
	curConsumer = consumer;
	$("#consumerStatsChart").empty();
	$("#consumerStatsTitle").html(consumer+"客户端状况统计");
	$('#consumerStatsModal').modal('show');
	$("[data-toggle='tooltip']").tooltip('hide');
}

/**
 * 获取统计图
 */
function consumerStats(){
	$.get('${request.contextPath}/consumer/stats',
	{
		consumer: curConsumer
	},
	function(data){
		$("#consumerStatsChart").html(data);
	});
}

function consumerRunningInfoModelShow(consumer, comp) {
	var clientId = $(comp).attr("clientId");
	if (!clientId) {
		alert("没有获取客户端链接无法进行操作");
		return;
	}
	post('${request.contextPath}/consumer/clientInfo',
	{
		consumer: consumer,
		clientId: clientId,
		cid: ${topic.clusterId}
	},
	function(data){
		$("#consumerRunningInfoClientIdSpan").html(clientId);
		$("#consumerRunningInfoModelBody").html(data);
		$('#consumerRunningInfoModel').modal('show');
	});
}

/**
 * 限制消费速率
 */
function showHttpConfigModel(consumerId, consumer) {
	$("#httpConsumeName").val(consumer);
	$("#httpConsumerId").val(consumerId);
	$.get('${request.contextPath}/consumer/http/config/' + consumer, function (data) {
		if (data.status == 200) {
			$("#pullSizeInput").val(data.result.maxPullSize);
			$("#pullTimeoutInput").val(data.result.consumerPullTimeoutInSeconds);
			$("#consumeTimeoutInput").val(data.result.consumeTimeoutInSeconds);
			$("#httpConfigModel").modal('show');
		} else {
			toastr.error("数据获取失败！" + data.message);
		}
	});
}

function httpConsumeConfig() {
	var pullSize = $("#pullSizeInput").val();
	if (!isValid("每次请求最多拉取消息量", pullSize, 1, 128)) {
		return;
	}
	var pullTimeout = $("#pullTimeoutInput").val();
	if (!isValid("请求拉取超时时间", pullTimeout, 1, 60)) {
		return;
	}
	var consumeTimeout = $("#consumeTimeoutInput").val();
	if (!isValid("消费超时时间", consumeTimeout, 10, 129600)) {
		return;
	}
	disable("httpConsumeBtn");
	$.post('${request.contextPath}/consumer/update/http/config',
			$("#httpConsumeConfigForm").serialize(),
			function(data){
				if(data.status == 200){
					toastr.success("申请成功，请稍后查看！即将跳转到我的工单");
					toMyAuditPage();
				}else{
					toastr.error("申请失败！"+data.message);
					enable("httpConsumeBtn");
				}
			}, 'json');
}

function isValid(flag, value, min, max) {
	var newValue = Number(value);
	if (!Number.isInteger(newValue)) {
		alert(flag + "只能为正整数");
		return false;
	}
	if (newValue < min) {
		alert(flag + "不能小于" + min);
		return false;
	}
	if (newValue > max) {
		alert(flag + "不能大于" + max);
		return false;
	}
	return true;
}
</script>